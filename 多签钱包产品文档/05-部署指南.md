# 多签钱包部署指南

**版本**: v1.0  
**文档类型**: 部署文档

---

## 1. 部署概述

本文档提供多签钱包的部署指南，包括环境要求、部署方式、配置说明和运维建议。多签钱包基于 MPC 基础设施，支持多种部署方式。

### 1.1 部署方式

- **Docker 部署**: 使用 Docker 容器部署（推荐开发测试）
- **Kubernetes 部署**: 使用 K8s 部署（推荐生产环境）
- **传统部署**: 直接在服务器上部署（特殊场景）

### 1.2 部署架构

```
┌─────────────────────────────────────┐
│         Load Balancer / API Gateway │
└──────────────┬──────────────────────┘
               │
    ┌──────────┼──────────┐
    │          │          │
┌───▼───┐  ┌───▼───┐  ┌───▼───┐
│Wallet │  │Wallet │  │Wallet │
│Service│  │Service│  │Service│
└───┬───┘  └───┬───┘  └───┬───┘
    │          │          │
    └──────────┼──────────┘
               │
    ┌──────────┼──────────┐
    │          │          │
┌───▼───┐  ┌───▼───┐  ┌───▼───┐
│Approval│ │Approval│ │Approval│
│Service │ │Service │ │Service │
└───┬───┘  └───┬───┘  └───┬───┘
    │          │          │
    └──────────┼──────────┘
               │
    ┌──────────┼──────────┐
    │          │          │
┌───▼───┐  ┌───▼───┐  ┌───▼───┐
│Signing│ │Signing│ │Signing│
│Service│ │Service│ │Service│
└───┬───┘  └───┬───┘  └───┬───┘
    │          │          │
    └──────────┼──────────┘
               │
    ┌──────────▼──────────┐
    │   MPC Infrastructure │
    │   (External Service)  │
    └──────────────────────┘
               │
    ┌──────────▼──────────┐
    │   Storage Layer      │
    │  ┌──────────────┐  │
    │  │PostgreSQL    │  │
    │  │Redis         │  │
    │  └──────────────┘  │
    └─────────────────────┘
```

---

## 2. 环境要求

### 2.1 硬件要求

#### 最小配置（开发测试）
- **CPU**: 4 核
- **内存**: 8 GB
- **磁盘**: 100 GB SSD
- **网络**: 100 Mbps

#### 推荐配置（生产环境）
- **CPU**: 8+ 核
- **内存**: 16+ GB
- **磁盘**: 500+ GB SSD（高性能）
- **网络**: 1 Gbps+

### 2.2 软件要求

#### 操作系统
- **Linux**: Ubuntu 20.04+, CentOS 8+, RHEL 8+
- **容器**: Docker 20.10+, Kubernetes 1.20+

#### 依赖软件
- **PostgreSQL**: 12+（元数据存储）
- **Redis**: 6.0+（会话缓存）
- **MPC 服务**: MPC 基础设施服务（外部服务）

---

## 3. Docker 部署

### 3.1 Docker Compose 部署

```yaml
# docker-compose.yml
version: '3.8'

services:
  postgres:
    image: postgres:14
    environment:
      POSTGRES_DB: multisig
      POSTGRES_USER: multisig
      POSTGRES_PASSWORD: ${DB_PASSWORD}
    volumes:
      - postgres_data:/var/lib/postgresql/data
    ports:
      - "5432:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U multisig"]
      interval: 10s
      timeout: 5s
      retries: 5

  redis:
    image: redis:7-alpine
    volumes:
      - redis_data:/data
    ports:
      - "6379:6379"
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  wallet-service:
    image: multisig-wallet:latest
    environment:
      - DB_HOST=postgres
      - DB_PORT=5432
      - DB_NAME=multisig
      - DB_USER=multisig
      - DB_PASSWORD=${DB_PASSWORD}
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - MPC_ENDPOINT=${MPC_ENDPOINT}
      - MPC_TOKEN=${MPC_TOKEN}
      - LOG_LEVEL=info
    ports:
      - "8080:8080"
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    volumes:
      - ./config:/etc/multisig
      - ./logs:/var/log/multisig

  approval-service:
    image: multisig-approval:latest
    environment:
      - DB_HOST=postgres
      - DB_PORT=5432
      - DB_NAME=multisig
      - DB_USER=multisig
      - DB_PASSWORD=${DB_PASSWORD}
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - LOG_LEVEL=info
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy

  signing-service:
    image: multisig-signing:latest
    environment:
      - DB_HOST=postgres
      - DB_PORT=5432
      - DB_NAME=multisig
      - DB_USER=multisig
      - DB_PASSWORD=${DB_PASSWORD}
      - MPC_ENDPOINT=${MPC_ENDPOINT}
      - MPC_TOKEN=${MPC_TOKEN}
      - LOG_LEVEL=info
    depends_on:
      postgres:
        condition: service_healthy

  notification-service:
    image: multisig-notification:latest
    environment:
      - DB_HOST=postgres
      - DB_PORT=5432
      - DB_NAME=multisig
      - DB_USER=multisig
      - DB_PASSWORD=${DB_PASSWORD}
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - SMTP_HOST=${SMTP_HOST}
      - SMTP_PORT=${SMTP_PORT}
      - SMTP_USER=${SMTP_USER}
      - SMTP_PASSWORD=${SMTP_PASSWORD}
      - LOG_LEVEL=info
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy

volumes:
  postgres_data:
  redis_data:
```

#### 启动服务

```bash
# 创建环境变量文件
cat > .env <<EOF
DB_PASSWORD=your-secure-password
MPC_ENDPOINT=https://api.mpc.example.com
MPC_TOKEN=your-mpc-token
SMTP_HOST=smtp.example.com
SMTP_PORT=587
SMTP_USER=your-email@example.com
SMTP_PASSWORD=your-email-password
EOF

# 启动服务
docker-compose up -d

# 查看日志
docker-compose logs -f wallet-service

# 检查服务状态
docker-compose ps
```

### 3.2 配置说明

#### 环境变量配置

```bash
# 数据库配置
DB_HOST=postgres
DB_PORT=5432
DB_NAME=multisig
DB_USER=multisig
DB_PASSWORD=your-password

# Redis 配置
REDIS_HOST=redis
REDIS_PORT=6379
REDIS_PASSWORD=  # 可选

# MPC 服务配置
MPC_ENDPOINT=https://api.mpc.example.com
MPC_TOKEN=your-mpc-token

# 服务配置
LISTEN_ADDRESS=0.0.0.0
LISTEN_PORT=8080
LOG_LEVEL=info  # debug, info, warn, error

# 安全配置
TLS_ENABLED=true
TLS_CERT_FILE=/etc/multisig/tls/cert.pem
TLS_KEY_FILE=/etc/multisig/tls/key.pem

# 认证配置
AUTH_TYPE=jwt  # jwt, oauth
JWT_SECRET=your-jwt-secret
JWT_TTL=24h

# 通知配置
SMTP_HOST=smtp.example.com
SMTP_PORT=587
SMTP_USER=your-email@example.com
SMTP_PASSWORD=your-email-password
```

---

## 4. Kubernetes 部署

### 4.1 部署清单

#### Namespace

```yaml
apiVersion: v1
kind: Namespace
metadata:
  name: multisig
```

#### ConfigMap

```yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: multisig-config
  namespace: multisig
data:
  config.yaml: |
    database:
      host: postgres
      port: 5432
      name: multisig
      user: multisig
    redis:
      host: redis
      port: 6379
    mpc:
      endpoint: https://api.mpc.example.com
    server:
      listen: "0.0.0.0:8080"
      tls:
        enabled: true
```

#### Secret

```yaml
apiVersion: v1
kind: Secret
metadata:
  name: multisig-secrets
  namespace: multisig
type: Opaque
stringData:
  db-password: your-db-password
  mpc-token: your-mpc-token
  jwt-secret: your-jwt-secret
  smtp-password: your-smtp-password
```

#### Deployment

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: multisig-wallet
  namespace: multisig
spec:
  replicas: 3
  selector:
    matchLabels:
      app: multisig
      service: wallet
  template:
    metadata:
      labels:
        app: multisig
        service: wallet
    spec:
      containers:
      - name: wallet-service
        image: multisig-wallet:latest
        ports:
        - containerPort: 8080
          name: http
        env:
        - name: DB_HOST
          value: postgres
        - name: DB_PASSWORD
          valueFrom:
            secretKeyRef:
              name: multisig-secrets
              key: db-password
        - name: MPC_ENDPOINT
          value: https://api.mpc.example.com
        - name: MPC_TOKEN
          valueFrom:
            secretKeyRef:
              name: multisig-secrets
              key: mpc-token
        resources:
          requests:
            cpu: 500m
            memory: 1Gi
          limits:
            cpu: 2000m
            memory: 4Gi
        livenessProbe:
          httpGet:
            path: /health
            port: 8080
          initialDelaySeconds: 30
          periodSeconds: 10
        readinessProbe:
          httpGet:
            path: /ready
            port: 8080
          initialDelaySeconds: 10
          periodSeconds: 5
```

#### Service

```yaml
apiVersion: v1
kind: Service
metadata:
  name: multisig-wallet
  namespace: multisig
spec:
  selector:
    app: multisig
    service: wallet
  ports:
  - port: 8080
    targetPort: 8080
    protocol: TCP
  type: ClusterIP
```

#### Ingress

```yaml
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: multisig-ingress
  namespace: multisig
  annotations:
    cert-manager.io/cluster-issuer: letsencrypt-prod
spec:
  tls:
  - hosts:
    - multisig.example.com
    secretName: multisig-tls
  rules:
  - host: multisig.example.com
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: multisig-wallet
            port:
              number: 8080
```

### 4.2 部署步骤

```bash
# 创建命名空间
kubectl create namespace multisig

# 创建 ConfigMap
kubectl apply -f configmap.yaml

# 创建 Secret
kubectl apply -f secret.yaml

# 部署服务
kubectl apply -f deployment.yaml

# 创建 Service
kubectl apply -f service.yaml

# 创建 Ingress
kubectl apply -f ingress.yaml

# 检查部署状态
kubectl get pods -n multisig
kubectl get svc -n multisig
kubectl get ingress -n multisig
```

---

## 5. 数据库部署

### 5.1 PostgreSQL 部署

#### 初始化脚本

```sql
-- init.sql
CREATE DATABASE multisig;

\c multisig;

-- 钱包表
CREATE TABLE wallets (
    wallet_id VARCHAR(255) PRIMARY KEY,
    name VARCHAR(255),
    description TEXT,
    threshold INTEGER,
    total_members INTEGER,
    chain_type VARCHAR(50),
    address TEXT,
    public_key TEXT,
    mpc_key_id VARCHAR(255),
    status VARCHAR(50),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 成员表
CREATE TABLE members (
    member_id VARCHAR(255) PRIMARY KEY,
    wallet_id VARCHAR(255),
    user_id VARCHAR(255),
    role VARCHAR(50),
    status VARCHAR(50),
    joined_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    last_active_at TIMESTAMP,
    FOREIGN KEY (wallet_id) REFERENCES wallets(wallet_id)
);

-- 交易表
CREATE TABLE transactions (
    tx_id VARCHAR(255) PRIMARY KEY,
    wallet_id VARCHAR(255),
    chain_type VARCHAR(50),
    from_address TEXT,
    to_address TEXT,
    value TEXT,
    gas_limit BIGINT,
    gas_price TEXT,
    nonce BIGINT,
    data BYTEA,
    status VARCHAR(50),
    description TEXT,
    tx_hash TEXT,
    block_number BIGINT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    approved_at TIMESTAMP,
    signed_at TIMESTAMP,
    broadcast_at TIMESTAMP,
    confirmed_at TIMESTAMP,
    FOREIGN KEY (wallet_id) REFERENCES wallets(wallet_id)
);

-- 审批请求表
CREATE TABLE approval_requests (
    request_id VARCHAR(255) PRIMARY KEY,
    wallet_id VARCHAR(255),
    tx_id VARCHAR(255),
    requester_id VARCHAR(255),
    status VARCHAR(50),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP,
    expires_at TIMESTAMP,
    FOREIGN KEY (wallet_id) REFERENCES wallets(wallet_id),
    FOREIGN KEY (tx_id) REFERENCES transactions(tx_id)
);

-- 审批记录表
CREATE TABLE approvals (
    approval_id VARCHAR(255) PRIMARY KEY,
    request_id VARCHAR(255),
    approver_id VARCHAR(255),
    comment TEXT,
    approved_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (request_id) REFERENCES approval_requests(request_id)
);

-- 地址白名单表
CREATE TABLE address_whitelist (
    id BIGSERIAL PRIMARY KEY,
    wallet_id VARCHAR(255),
    address TEXT,
    label VARCHAR(255),
    description TEXT,
    added_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (wallet_id) REFERENCES wallets(wallet_id)
);

-- 地址黑名单表
CREATE TABLE address_blacklist (
    id BIGSERIAL PRIMARY KEY,
    wallet_id VARCHAR(255),
    address TEXT,
    reason TEXT,
    added_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (wallet_id) REFERENCES wallets(wallet_id)
);

-- 审批规则表
CREATE TABLE approval_rules (
    wallet_id VARCHAR(255) PRIMARY KEY,
    min_amount TEXT,
    max_amount TEXT,
    require_whitelist BOOLEAN,
    max_daily_amount TEXT,
    max_daily_count INTEGER,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP,
    FOREIGN KEY (wallet_id) REFERENCES wallets(wallet_id)
);

-- 审计日志表
CREATE TABLE audit_logs (
    id BIGSERIAL PRIMARY KEY,
    timestamp TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    event_type VARCHAR(50),
    user_id VARCHAR(255),
    wallet_id VARCHAR(255),
    tx_id VARCHAR(255),
    operation VARCHAR(50),
    result VARCHAR(50),
    details JSONB,
    ip_address VARCHAR(50)
);

-- 创建索引
CREATE INDEX idx_wallets_user_id ON wallets(wallet_id);
CREATE INDEX idx_wallets_status ON wallets(status);
CREATE INDEX idx_members_wallet_id ON members(wallet_id);
CREATE INDEX idx_transactions_wallet_id ON transactions(wallet_id);
CREATE INDEX idx_transactions_status ON transactions(status);
CREATE INDEX idx_approvals_request_id ON approvals(request_id);
CREATE INDEX idx_audit_timestamp ON audit_logs(timestamp);
CREATE INDEX idx_audit_wallet_id ON audit_logs(wallet_id);
```

---

## 6. MPC 服务集成

### 6.1 MPC 服务配置

#### 连接配置
```yaml
# config.yaml
mpc:
  endpoint: https://api.mpc.example.com
  token: ${MPC_TOKEN}
  timeout: 30s
  retry:
    max_attempts: 3
    backoff: exponential
```

#### 健康检查
```bash
# 检查 MPC 服务连接
curl -H "Authorization: Bearer $MPC_TOKEN" \
  https://api.mpc.example.com/v1/health
```

---

## 7. 监控配置

### 7.1 Prometheus 配置

#### Metrics 端点
```yaml
# 多签钱包暴露 metrics 端点
/metrics

# Prometheus 配置
scrape_configs:
  - job_name: 'multisig-wallet'
    static_configs:
      - targets: ['multisig-wallet:8080']
    metrics_path: '/metrics'
```

### 7.2 Grafana 仪表板

#### 关键指标
- 钱包创建数
- 交易数量
- 审批数量
- 签名成功率
- API 响应时间
- 错误率

---

## 8. 备份与恢复

### 8.1 数据备份

#### 自动备份脚本
```bash
#!/bin/bash
# backup.sh

BACKUP_DIR=/backup/multisig
DATE=$(date +%Y%m%d_%H%M%S)
DB_NAME=multisig
DB_USER=multisig

# 创建备份目录
mkdir -p $BACKUP_DIR

# 备份数据库
pg_dump -U $DB_USER -d $DB_NAME | gzip > $BACKUP_DIR/multisig_$DATE.sql.gz

# 删除 30 天前的备份
find $BACKUP_DIR -name "*.sql.gz" -mtime +30 -delete
```

#### Cron 定时任务
```bash
# 每天凌晨 2 点备份
0 2 * * * /usr/local/bin/backup.sh
```

### 8.2 恢复流程

```bash
# 停止服务
docker-compose stop wallet-service approval-service signing-service

# 恢复数据库
gunzip < /backup/multisig/multisig_20240115_020000.sql.gz | \
  psql -U multisig -d multisig

# 启动服务
docker-compose start wallet-service approval-service signing-service
```

---

## 9. 安全加固

### 9.1 网络安全

#### 防火墙规则
```bash
# 仅允许必要的端口
ufw allow 22/tcp   # SSH
ufw allow 8080/tcp  # API
ufw enable
```

#### TLS 配置
```bash
# 生成自签名证书（开发环境）
openssl req -x509 -newkey rsa:4096 -keyout key.pem -out cert.pem -days 365 -nodes

# 使用 Let's Encrypt（生产环境）
certbot certonly --standalone -d multisig.example.com
```

### 9.2 访问控制

#### API 访问限制
```yaml
# Nginx 配置
location /v1/ {
    # IP 白名单（可选）
    allow 192.168.1.0/24;
    deny all;
    
    # 限流
    limit_req zone=api_limit burst=10 nodelay;
    
    proxy_pass http://multisig-wallet:8080;
}
```

---

## 10. 性能优化

### 10.1 数据库优化

```sql
-- postgresql.conf
max_connections = 200
shared_buffers = 4GB
effective_cache_size = 12GB
maintenance_work_mem = 1GB
checkpoint_completion_target = 0.9
wal_buffers = 16MB
default_statistics_target = 100
random_page_cost = 1.1
effective_io_concurrency = 200
work_mem = 20MB
min_wal_size = 1GB
max_wal_size = 4GB
```

### 10.2 Redis 优化

```conf
# redis.conf
maxmemory 2gb
maxmemory-policy allkeys-lru
save ""  # 禁用持久化（仅缓存）
```

---

## 11. 故障排查

### 11.1 日志查看

```bash
# Docker 日志
docker-compose logs -f wallet-service

# Kubernetes 日志
kubectl logs -f deployment/multisig-wallet -n multisig

# 应用日志
tail -f /var/log/multisig/wallet.log
```

### 11.2 健康检查

```bash
# 健康检查端点
curl http://localhost:8080/health

# 就绪检查端点
curl http://localhost:8080/ready

# 指标端点
curl http://localhost:8080/metrics
```

### 11.3 常见问题

#### MPC 服务连接失败
- 检查 MPC 服务是否运行
- 检查网络连接
- 检查认证 Token

#### 数据库连接失败
- 检查数据库服务是否运行
- 检查网络连接
- 检查认证信息

#### 审批流程异常
- 检查审批规则配置
- 检查成员权限
- 查看审批日志

---

## 12. 升级指南

### 12.1 升级流程

```bash
# 1. 备份数据
./backup.sh

# 2. 停止服务
docker-compose stop wallet-service

# 3. 拉取新镜像
docker-compose pull multisig-wallet

# 4. 启动服务
docker-compose up -d wallet-service

# 5. 验证服务
curl http://localhost:8080/health

# 6. 回滚（如需要）
docker-compose down
docker-compose up -d multisig-wallet:previous-version
```

### 12.2 数据库迁移

```bash
# 运行数据库迁移脚本
docker-compose exec wallet-service ./migrate up
```

---

**文档维护**: 运维团队  
**最后更新**: 2024





