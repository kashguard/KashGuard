# 多签钱包架构设计文档

**版本**: v1.0  
**文档类型**: 技术架构

---

## 1. 架构概述

多签钱包采用微服务架构设计，基于 MPC 基础设施，提供安全、可靠、易用的多签名钱包服务。架构支持水平扩展、高可用部署，满足企业级应用需求。

### 1.1 架构原则

- **微服务架构**: 清晰的服务划分，职责分离
- **基于 MPC**: 基于 MPC 基础设施，无需私钥重构
- **安全优先**: 多层安全防护，完整的审计日志
- **高可用**: 多节点部署，自动故障转移
- **高性能**: 低延迟签名，高吞吐量
- **易扩展**: 水平扩展，支持大规模部署

### 1.2 架构图

```
┌─────────────────────────────────────────────────────────┐
│                   客户端层 (Clients)                     │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌─────────┐ │
│  │ Web UI   │  │ Mobile   │  │  CLI     │  │  API   │ │
│  └────┬─────┘  └────┬─────┘  └────┬─────┘  └────┬─────┘ │
└───────┼─────────────┼─────────────┼─────────────┼───────┘
        │             │             │             │
        └─────────────┴─────────────┴─────────────┘
                            │
        ┌───────────────────▼───────────────────┐
        │          API Gateway / Load Balancer  │
        │      (认证、限流、路由、监控)            │
        └───────────────────┬───────────────────┘
                            │
        ┌───────────────────▼───────────────────┐
        │         Multi-Sig Wallet Services     │
        │  ┌──────────┐  ┌──────────┐          │
        │  │  HTTP    │  │  gRPC    │          │
        │  │  Server  │  │  Server  │          │
        │  └────┬─────┘  └────┬─────┘          │
        └───────┼─────────────┼─────────────────┘
                │             │
        ┌───────▼─────────────▼───────┐
        │      Core Business Logic    │
        │  ┌────────────────────────┐ │
        │  │  Wallet Service        │ │
        │  │  (钱包管理)            │ │
        │  ├────────────────────────┤ │
        │  │  Approval Service      │ │
        │  │  (审批流程)            │ │
        │  ├────────────────────────┤ │
        │  │  Signing Service       │ │
        │  │  (签名服务)            │ │
        │  ├────────────────────────┤ │
        │  │  Notification Service  │ │
        │  │  (通知服务)            │ │
        │  └────────────────────────┘ │
        └───────┬───────────────────────┘
                │
        ┌───────▼───────────────────────┐
        │      MPC Infrastructure       │
        │  ┌──────────────────────────┐ │
        │  │  MPC Coordinator         │ │
        │  │  (MPC 协调服务)           │ │
        │  └──────────────────────────┘ │
        │  ┌──────────────────────────┐ │
        │  │  MPC Participants        │ │
        │  │  (MPC 参与节点)           │ │
        │  └──────────────────────────┘ │
        └───────┬───────────────────────┘
                │
        ┌───────▼───────────────────────┐
        │      Storage Layer           │
        │  ┌──────────────────────────┐ │
        │  │  Wallet Metadata         │ │
        │  │  (PostgreSQL)            │ │
        │  ├──────────────────────────┤ │
        │  │  Approval Workflow       │ │
        │  │  (PostgreSQL)            │ │
        │  ├──────────────────────────┤ │
        │  │  Session Cache           │ │
        │  │  (Redis)                 │ │
        │  ├──────────────────────────┤ │
        │  │  Audit Logs              │ │
        │  │  (PostgreSQL + Archive)  │ │
        │  └──────────────────────────┘ │
        └───────────────────────────────┘
```

---

## 2. 核心组件

### 2.1 Wallet Service（钱包服务）

**职责**:
- 钱包创建和管理
- 成员管理
- 权限配置
- 资产查询

**核心模块**:

#### 2.1.1 Wallet Manager
```go
type WalletManager interface {
    // 创建钱包
    CreateWallet(req *CreateWalletRequest) (*Wallet, error)
    
    // 获取钱包信息
    GetWallet(walletID string) (*Wallet, error)
    
    // 更新钱包配置
    UpdateWallet(walletID string, req *UpdateWalletRequest) error
    
    // 删除钱包
    DeleteWallet(walletID string) error
    
    // 列出钱包
    ListWallets(filter *WalletFilter) ([]*Wallet, error)
}
```

#### 2.1.2 Member Manager
```go
type MemberManager interface {
    // 添加成员
    AddMember(walletID string, member *Member) error
    
    // 移除成员
    RemoveMember(walletID string, memberID string) error
    
    // 更新成员角色
    UpdateMemberRole(walletID string, memberID string, role string) error
    
    // 获取成员列表
    GetMembers(walletID string) ([]*Member, error)
}
```

#### 2.1.3 Permission Manager
```go
type PermissionManager interface {
    // 设置权限
    SetPermission(walletID string, role string, permissions *Permissions) error
    
    // 获取权限
    GetPermission(walletID string, role string) (*Permissions, error)
    
    // 验证权限
    CheckPermission(walletID string, userID string, action string) (bool, error)
}
```

### 2.2 Approval Service（审批服务）

**职责**:
- 交易审批流程
- 审批规则管理
- 审批历史记录

**核心模块**:

#### 2.2.1 Approval Workflow
```go
type ApprovalWorkflow interface {
    // 创建审批请求
    CreateApprovalRequest(req *ApprovalRequest) (*ApprovalRequest, error)
    
    // 审批交易
    ApproveTransaction(requestID string, approverID string) error
    
    // 拒绝交易
    RejectTransaction(requestID string, approverID string, reason string) error
    
    // 获取审批状态
    GetApprovalStatus(requestID string) (*ApprovalStatus, error)
    
    // 自动执行（达到阈值后）
    AutoExecute(requestID string) error
}
```

#### 2.2.2 Approval Rules
```go
type ApprovalRules interface {
    // 设置审批规则
    SetApprovalRule(walletID string, rule *ApprovalRule) error
    
    // 获取审批规则
    GetApprovalRule(walletID string) (*ApprovalRule, error)
    
    // 验证审批规则
    ValidateApprovalRule(walletID string, tx *Transaction) (bool, error)
}
```

### 2.3 Signing Service（签名服务）

**职责**:
- 调用 MPC 服务进行签名
- 交易构建
- 签名状态管理

**核心模块**:

#### 2.3.1 Signing Manager
```go
type SigningManager interface {
    // 创建签名请求
    CreateSigningRequest(req *SigningRequest) (*SigningRequest, error)
    
    // 执行签名（调用 MPC）
    ExecuteSigning(requestID string) (*Signature, error)
    
    // 获取签名状态
    GetSigningStatus(requestID string) (*SigningStatus, error)
    
    // 广播交易
    BroadcastTransaction(tx *Transaction) error
}
```

### 2.4 Notification Service（通知服务）

**职责**:
- 审批通知
- 交易通知
- 系统通知

**核心模块**:

#### 2.4.1 Notification Manager
```go
type NotificationManager interface {
    // 发送通知
    SendNotification(notification *Notification) error
    
    // 发送审批通知
    SendApprovalNotification(requestID string) error
    
    // 发送交易通知
    SendTransactionNotification(txID string) error
    
    // 配置通知渠道
    ConfigureNotificationChannel(userID string, channel *NotificationChannel) error
}
```

---

## 3. 数据模型

### 3.1 Wallet（钱包）

```go
type Wallet struct {
    WalletID      string    // 钱包ID
    Name          string    // 钱包名称
    Description   string    // 描述
    Threshold     int       // 阈值（M）
    TotalMembers  int       // 总成员数（N）
    ChainType     string    // 链类型
    Address       string    // 钱包地址
    PublicKey     string    // 公钥
    Status        string    // 状态（active, inactive, deleted）
    CreatedAt     time.Time
    UpdatedAt     time.Time
    Members       []*Member // 成员列表
    Permissions   *Permissions // 权限配置
}
```

### 3.2 Member（成员）

```go
type Member struct {
    MemberID      string    // 成员ID
    WalletID      string    // 钱包ID
    UserID        string    // 用户ID
    Role          string    // 角色（admin, approver, observer）
    Status        string    // 状态（active, inactive）
    JoinedAt      time.Time
    LastActiveAt  time.Time
}
```

### 3.3 Transaction（交易）

```go
type Transaction struct {
    TxID          string    // 交易ID
    WalletID      string    // 钱包ID
    ChainType     string    // 链类型
    From          string    // 发送地址
    To            string    // 接收地址
    Amount        string    // 金额
    GasLimit      uint64    // Gas 限制
    GasPrice      string    // Gas 价格
    Nonce         uint64    // Nonce
    Data          []byte    // 交易数据
    Status        string    // 状态（pending, approved, signed, broadcast, confirmed, failed）
    CreatedAt     time.Time
    ApprovedAt    time.Time
    SignedAt      time.Time
    BroadcastAt   time.Time
    ConfirmedAt   time.Time
}
```

### 3.4 ApprovalRequest（审批请求）

```go
type ApprovalRequest struct {
    RequestID     string    // 请求ID
    WalletID      string    // 钱包ID
    TxID          string    // 交易ID
    RequesterID   string    // 请求者ID
    Status        string    // 状态（pending, approved, rejected）
    Approvals     []*Approval // 审批记录
    Rejections    []*Rejection // 拒绝记录
    CreatedAt     time.Time
    UpdatedAt     time.Time
    ExpiresAt     time.Time
}
```

### 3.5 Approval（审批记录）

```go
type Approval struct {
    ApprovalID    string    // 审批ID
    RequestID     string    // 请求ID
    ApproverID    string    // 审批者ID
    ApprovedAt    time.Time
    Comment       string    // 备注
}
```

---

## 4. 工作流程

### 4.1 钱包创建流程

```
1. 用户发起创建钱包请求
   ↓
2. Wallet Service 验证权限
   ↓
3. 调用 MPC 服务生成密钥分片
   ├── 创建 MPC 密钥
   ├── 分发密钥分片给成员
   └── 生成钱包地址
   ↓
4. 创建钱包元数据
   ├── 保存钱包信息
   ├── 保存成员信息
   └── 保存权限配置
   ↓
5. 返回钱包信息
```

### 4.2 交易审批流程

```
1. 用户发起交易请求
   ↓
2. Approval Service 验证权限和规则
   ├── 检查地址白名单/黑名单
   ├── 检查金额限制
   └── 检查审批规则
   ↓
3. 创建审批请求
   ├── 保存交易信息
   ├── 创建审批请求
   └── 发送审批通知
   ↓
4. 审批者审批
   ├── 审批者查看交易详情
   ├── 审批者审批/拒绝
   └── 更新审批状态
   ↓
5. 检查是否达到阈值
   ├── 如果达到阈值 → 自动执行签名
   └── 如果未达到 → 等待更多审批
   ↓
6. 调用 MPC 服务签名
   ├── 创建签名会话
   ├── 多方参与签名
   └── 生成最终签名
   ↓
7. 广播交易
   ├── 构建完整交易
   ├── 广播到区块链
   └── 更新交易状态
   ↓
8. 发送交易通知
```

### 4.3 签名流程

```
1. Approval Service 触发签名
   ↓
2. Signing Service 创建签名请求
   ↓
3. 调用 MPC 服务
   ├── 创建签名会话
   ├── 通知参与节点
   ├── 执行阈值签名协议
   └── 生成最终签名
   ↓
4. 构建完整交易
   ├── 组装交易数据
   ├── 添加签名
   └── 验证交易
   ↓
5. 广播交易
   ├── 发送到区块链网络
   └── 等待确认
   ↓
6. 更新交易状态
   ├── 更新为已广播
   └── 等待确认后更新为已确认
```

---

## 5. 与 MPC 基础设施集成

### 5.1 集成架构

```
Multi-Sig Wallet Service
        │
        ├── Wallet Service
        │       │
        │       └── MPC Service (创建密钥)
        │
        ├── Approval Service
        │       │
        │       └── (审批流程，不直接调用 MPC)
        │
        └── Signing Service
                │
                └── MPC Service (阈值签名)
```

### 5.2 MPC 服务调用

#### 创建密钥
```go
// 调用 MPC 服务创建密钥
mpcClient := mpc.NewClient(&mpc.Config{
    Endpoint: "https://api.mpc.example.com",
    Token:    mpcToken,
})

key, err := mpcClient.CreateKey(&mpc.CreateKeyRequest{
    Algorithm: "ECDSA",
    Curve:     "secp256k1",
    Threshold: threshold,
    TotalNodes: totalMembers,
    ChainType: chainType,
})
```

#### 阈值签名
```go
// 调用 MPC 服务进行签名
signature, err := mpcClient.Sign(&mpc.SignRequest{
    KeyID:     wallet.MPCKeyID,
    Message:   txHash,
    ChainType: chainType,
})
```

---

## 6. 高可用架构

### 6.1 服务部署

```
┌─────────────────────────────────────┐
│         Load Balancer               │
└──────────────┬──────────────────────┘
               │
    ┌──────────┼──────────┐
    │          │          │
┌───▼───┐  ┌───▼───┐  ┌───▼───┐
│Wallet │  │Wallet │  │Wallet │
│Service│  │Service│  │Service│
└───┬───┘  └───┬───┘  └───┬───┘
    │          │          │
    └──────────┼──────────┘
               │
    ┌──────────┼──────────┐
    │          │          │
┌───▼───┐  ┌───▼───┐  ┌───▼───┐
│Approval│ │Approval│ │Approval│
│Service │ │Service │ │Service │
└───┬───┘  └───┬───┘  └───┬───┘
    │          │          │
    └──────────┼──────────┘
               │
    ┌──────────┼──────────┐
    │          │          │
┌───▼───┐  ┌───▼───┐  ┌───▼───┐
│Signing│ │Signing│ │Signing│
│Service│ │Service│ │Service│
└───────┘  └───────┘  └───────┘
```

### 6.2 数据存储

#### 主从复制
- PostgreSQL 主从复制
- 读写分离
- 自动故障转移

#### 缓存层
- Redis 集群
- 会话缓存
- 热点数据缓存

---

## 7. 性能优化

### 7.1 数据库优化

#### 索引优化
```sql
-- 钱包表索引
CREATE INDEX idx_wallets_user_id ON wallets(user_id);
CREATE INDEX idx_wallets_status ON wallets(status);
CREATE INDEX idx_wallets_chain_type ON wallets(chain_type);

-- 交易表索引
CREATE INDEX idx_transactions_wallet_id ON transactions(wallet_id);
CREATE INDEX idx_transactions_status ON transactions(status);
CREATE INDEX idx_transactions_created_at ON transactions(created_at);

-- 审批表索引
CREATE INDEX idx_approvals_request_id ON approvals(request_id);
CREATE INDEX idx_approvals_status ON approvals(status);
```

#### 查询优化
- 避免全表扫描
- 使用连接池
- 读写分离

### 7.2 缓存策略

#### Redis 缓存
- 钱包元数据缓存（TTL: 5分钟）
- 成员信息缓存（TTL: 10分钟）
- 审批状态缓存（TTL: 1分钟）
- 交易状态缓存（TTL: 30秒）

### 7.3 异步处理

#### 异步任务
- 审批通知（异步发送）
- 交易广播（异步处理）
- 审计日志（异步写入）
- 数据统计（定时任务）

---

## 8. 技术选型

### 8.1 开发语言

#### 推荐: Go
- **优势**: 
  - 并发支持好
  - 性能优秀
  - 部署简单
  - 与 MPC 服务技术栈一致

### 8.2 框架和库

#### Web 框架
- **Gin**: 轻量级 Web 框架
- **Echo**: 高性能 Web 框架

#### 数据库
- **PostgreSQL**: 主数据库
- **Redis**: 缓存和会话存储

#### 消息队列
- **RabbitMQ**: 异步任务队列
- **Kafka**: 事件流处理（可选）

### 8.3 前端技术

#### Web 前端
- **React**: UI 框架
- **TypeScript**: 类型安全
- **Ant Design**: UI 组件库

#### 移动端
- **React Native**: 跨平台移动应用
- **Flutter**: 备选方案

---

## 9. 安全架构

### 9.1 认证授权

#### 用户认证
- JWT Token 认证
- OAuth 2.0 支持
- 多因素认证（MFA）

#### 权限控制
- 基于角色的访问控制（RBAC）
- 钱包级别权限
- 操作级别权限

### 9.2 数据安全

#### 数据加密
- 敏感数据加密存储
- 传输加密（TLS）
- 密钥管理（KMS）

#### 审计日志
- 所有操作记录
- 不可篡改
- 长期保存

---

## 10. 监控与运维

### 10.1 监控指标

#### 业务指标
- 钱包创建数
- 交易数量
- 审批数量
- 签名成功率

#### 性能指标
- API 响应时间
- 签名延迟
- 数据库查询时间
- 缓存命中率

#### 系统指标
- CPU、内存使用率
- 网络流量
- 错误率

### 10.2 日志管理

#### 应用日志
- 结构化日志（JSON）
- 日志级别（DEBUG、INFO、WARN、ERROR）
- 日志聚合（ELK Stack）

#### 审计日志
- 所有操作记录
- 不可篡改
- 长期保存

---

**文档维护**: 架构团队  
**最后更新**: 2024

