# KMS 架构设计文档

**版本**: v1.0  
**文档类型**: 技术架构

---

## 1. 架构概述

KMS 采用分层、模块化的架构设计，参考 HashiCorp Vault 的架构理念，确保高可用、可扩展、安全可靠。

### 1.1 架构原则

- **分层架构**: 清晰的层次划分，职责分离
- **模块化设计**: 插件化架构，易于扩展
- **安全优先**: 零信任架构，深度防御
- **高可用**: 多节点集群，自动故障转移
- **可扩展**: 水平扩展，支持大规模部署

### 1.2 架构图

```
┌─────────────────────────────────────────────────────────┐
│                   客户端层 (Clients)                     │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌─────────┐ │
│  │ Web UI   │  │  CLI     │  │  SDK     │  │  API    │ │
│  └────┬─────┘  └────┬─────┘  └────┬─────┘  └────┬─────┘ │
└───────┼─────────────┼─────────────┼─────────────┼───────┘
        │             │             │             │
        └─────────────┴─────────────┴─────────────┘
                            │
        ┌───────────────────▼───────────────────┐
        │          API Gateway / Load Balancer  │
        │      (认证、限流、路由、监控)            │
        └───────────────────┬───────────────────┘
                            │
        ┌───────────────────▼───────────────────┐
        │         KMS Core Service Layer        │
        │  ┌──────────┐  ┌──────────┐          │
        │  │  HTTP    │  │  gRPC    │          │
        │  │  Server  │  │  Server  │          │
        │  └────┬─────┘  └────┬─────┘          │
        └───────┼─────────────┼─────────────────┘
                │             │
        ┌───────▼─────────────▼───────┐
        │      Core Business Logic    │
        │  ┌────────────────────────┐ │
        │  │  Key Management       │ │
        │  │  Encryption Service   │ │
        │  │  Policy Engine        │ │
        │  │  Audit Logger         │ │
        │  └────────────────────────┘ │
        └───────┬───────────────────────┘
                │
        ┌───────▼───────────────────────┐
        │      Storage Abstraction      │
        │  ┌──────────────────────────┐ │
        │  │  Metadata Store          │ │
        │  │  (PostgreSQL/Consul)    │ │
        │  └──────────────────────────┘ │
        │  ┌──────────────────────────┐ │
        │  │  HSM Adapter            │ │
        │  │  (PKCS#11 Interface)    │ │
        │  └──────────────────────────┘ │
        └───────┬───────────────────────┘
                │
        ┌───────▼───────────────────────┐
        │      Storage Backend          │
        │  ┌──────────┐  ┌──────────┐  │
        │  │PostgreSQL│  │  Consul  │  │
        │  │  MySQL   │  │   etc.   │  │
        │  └──────────┘  └──────────┘  │
        │  ┌──────────┐  ┌──────────┐  │
        │  │   HSM    │  │  Redis   │  │
        │  │ (PKCS#11)│  │ (Cache)  │  │
        │  └──────────┘  └──────────┘  │
        └──────────────────────────────┘
```

---

## 2. 核心组件

### 2.1 API Gateway

**职责**:
- 请求路由和负载均衡
- 认证和授权（前置验证）
- 限流和熔断
- 请求日志记录
- SSL/TLS 终止

**技术选型**:
- Nginx / Envoy / Kong
- 支持 gRPC 和 HTTP

### 2.2 KMS Core Service

**职责**:
- 处理业务逻辑
- 密钥管理操作
- 加密解密服务
- 策略验证
- 审计日志记录

**核心模块**:

#### 2.2.1 Key Management Module
```go
type KeyManager interface {
    CreateKey(req *CreateKeyRequest) (*KeyMetadata, error)
    GetKey(keyID string) (*KeyMetadata, error)
    UpdateKey(keyID string, req *UpdateKeyRequest) error
    DeleteKey(keyID string) error
    EnableKey(keyID string) error
    DisableKey(keyID string) error
    RotateKey(keyID string) error
    ListKeys(filter *KeyFilter) ([]*KeyMetadata, error)
}
```

#### 2.2.2 Encryption Service Module
```go
type EncryptionService interface {
    Encrypt(req *EncryptRequest) (*EncryptResponse, error)
    Decrypt(req *DecryptRequest) (*DecryptResponse, error)
    GenerateDataKey(req *GenerateDataKeyRequest) (*GenerateDataKeyResponse, error)
    Sign(req *SignRequest) (*SignResponse, error)
    Verify(req *VerifyRequest) (*VerifyResponse, error)
}
```

#### 2.2.3 Policy Engine
```go
type PolicyEngine interface {
    EvaluatePolicy(policy *Policy, request *AccessRequest) (bool, error)
    LoadPolicy(policyID string) (*Policy, error)
    UpdatePolicy(policyID string, policy *Policy) error
    DeletePolicy(policyID string) error
}
```

#### 2.2.4 Audit Logger
```go
type AuditLogger interface {
    LogEvent(event *AuditEvent) error
    QueryEvents(filter *EventFilter) ([]*AuditEvent, error)
    ExportEvents(filter *EventFilter, format string) ([]byte, error)
}
```

### 2.3 Storage Abstraction Layer

参考 HashiCorp Vault 的存储抽象设计，提供统一的存储接口。

#### 2.3.1 Metadata Store Interface
```go
type MetadataStore interface {
    // 密钥元数据操作
    SaveKeyMetadata(key *KeyMetadata) error
    GetKeyMetadata(keyID string) (*KeyMetadata, error)
    UpdateKeyMetadata(keyID string, updates map[string]interface{}) error
    DeleteKeyMetadata(keyID string) error
    ListKeyMetadata(filter *KeyFilter) ([]*KeyMetadata, error)
    
    // 策略操作
    SavePolicy(policy *Policy) error
    GetPolicy(policyID string) (*Policy, error)
    ListPolicies() ([]*Policy, error)
    
    // 审计日志
    SaveAuditLog(event *AuditEvent) error
    QueryAuditLogs(filter *EventFilter) ([]*AuditEvent, error)
}
```

#### 2.3.2 HSM Adapter Interface
```go
type HSMAdapter interface {
    // 密钥操作
    GenerateKey(keySpec *KeySpec) (string, error) // 返回密钥句柄
    ImportKey(keyMaterial []byte, keySpec *KeySpec) (string, error)
    DeleteKey(handle string) error
    
    // 加密操作
    Encrypt(handle string, plaintext []byte) ([]byte, error)
    Decrypt(handle string, ciphertext []byte) ([]byte, error)
    
    // 签名操作
    Sign(handle string, digest []byte) ([]byte, error)
    Verify(handle string, digest []byte, signature []byte) (bool, error)
    
    // 密钥属性
    GetKeyAttributes(handle string) (*KeyAttributes, error)
}
```

### 2.4 Storage Backend

#### 2.4.1 Metadata Storage

**PostgreSQL 实现**:
```sql
-- 密钥元数据表
CREATE TABLE keys (
    key_id VARCHAR(255) PRIMARY KEY,
    alias VARCHAR(255) UNIQUE,
    description TEXT,
    key_type VARCHAR(50),
    key_state VARCHAR(50),
    key_spec JSONB,
    policy_id VARCHAR(255),
    created_at TIMESTAMP,
    updated_at TIMESTAMP,
    deletion_date TIMESTAMP,
    tags JSONB
);

-- 密钥版本表
CREATE TABLE key_versions (
    key_id VARCHAR(255),
    version INTEGER,
    hsm_handle VARCHAR(255),
    is_primary BOOLEAN,
    created_at TIMESTAMP,
    PRIMARY KEY (key_id, version)
);

-- 策略表
CREATE TABLE policies (
    policy_id VARCHAR(255) PRIMARY KEY,
    policy_document JSONB,
    created_at TIMESTAMP,
    updated_at TIMESTAMP
);

-- 审计日志表
CREATE TABLE audit_logs (
    id BIGSERIAL PRIMARY KEY,
    timestamp TIMESTAMP,
    event_type VARCHAR(50),
    user_id VARCHAR(255),
    key_id VARCHAR(255),
    operation VARCHAR(50),
    result VARCHAR(50),
    details JSONB,
    ip_address VARCHAR(50)
);
CREATE INDEX idx_audit_timestamp ON audit_logs(timestamp);
CREATE INDEX idx_audit_key_id ON audit_logs(key_id);
```

**Consul 实现**:
- 使用 Consul KV Store 存储密钥元数据
- 使用 Consul Sessions 实现分布式锁
- 利用 Consul 的一致性保证

#### 2.4.2 HSM Storage

**PKCS#11 实现**:
- 使用 PKCS#11 标准接口
- 支持多种 HSM 设备（Thales, Utimaco, AWS CloudHSM 等）
- 密钥存储在 HSM 内部，永不离开

#### 2.4.3 Cache Layer

**Redis 实现**:
- 缓存密钥元数据（减少数据库查询）
- 缓存策略信息
- 缓存 HSM 连接池
- TTL 设置（5-10分钟）

---

## 3. 认证与授权架构

### 3.1 认证流程

```
Client Request
    │
    ▼
[API Gateway] ──→ 提取 Token/凭证
    │
    ▼
[Auth Service] ──→ 验证 Token/凭证
    │
    ▼
[Identity Provider]
    ├── Token Auth
    ├── AppRole
    ├── LDAP/AD
    ├── OAuth 2.0
    └── Kubernetes SA
    │
    ▼
返回用户身份信息
```

### 3.2 授权流程

```
Authenticated Request
    │
    ▼
[Policy Engine] ──→ 加载策略
    │
    ▼
[Policy Evaluation] ──→ 评估权限
    │
    ├── Key-level Policy
    ├── Global Policy
    └── Role Policy
    │
    ▼
[Access Decision] ──→ 允许/拒绝
```

### 3.3 策略模型

参考 HashiCorp Vault 的 Policy 语法：

```hcl
# 密钥策略示例
path "keys/*" {
  capabilities = ["create", "read", "update", "delete"]
}

path "keys/my-key" {
  capabilities = ["read", "use"]
  
  # 加密上下文要求
  required_parameters = ["encryption_context"]
}

path "keys/my-key/encrypt" {
  capabilities = ["update"]
  
  # 限制条件
  allowed_parameters = {
    "encryption_context" = ["project=prod", "env=production"]
  }
}
```

---

## 4. 高可用架构

### 4.1 集群架构

```
                    ┌─────────────┐
                    │ Load Balancer│
                    └──────┬──────┘
                           │
        ┌──────────────────┼──────────────────┐
        │                  │                  │
   ┌────▼────┐        ┌────▼────┐        ┌────▼────┐
   │ KMS     │        │ KMS     │        │ KMS     │
   │ Node 1  │◄──────►│ Node 2  │◄──────►│ Node 3  │
   └────┬────┘        └────┬────┘        └────┬────┘
        │                  │                  │
        └──────────────────┼──────────────────┘
                           │
        ┌──────────────────┼──────────────────┐
        │                  │                  │
   ┌────▼────┐        ┌────▼────┐        ┌────▼────┐
   │PostgreSQL│◄──────►│PostgreSQL│◄──────►│PostgreSQL│
   │Primary   │        │Replica  │        │Replica  │
   └──────────┘        └─────────┘        └─────────┘
        │
   ┌────▼────┐
   │   HSM   │
   │ Cluster │
   └─────────┘
```

### 4.2 一致性保证

- **元数据一致性**: 使用 PostgreSQL 主从复制或 Consul 一致性
- **HSM 同步**: 密钥在多个 HSM 节点间同步
- **缓存一致性**: Redis 缓存失效策略

### 4.3 故障转移

- **自动故障检测**: 健康检查机制
- **自动故障转移**: 主节点故障时自动切换
- **数据恢复**: 从备份恢复数据

---

## 5. 安全架构

### 5.1 深度防御

```
Layer 1: 网络层
  ├── 防火墙规则
  ├── DDoS 防护
  └── 网络隔离

Layer 2: 应用层
  ├── TLS/SSL 加密
  ├── 认证授权
  └── 输入验证

Layer 3: 数据层
  ├── 密钥加密存储
  ├── HSM 硬件保护
  └── 数据备份加密

Layer 4: 审计层
  ├── 操作日志
  ├── 访问日志
  └── 安全事件监控
```

### 5.2 密钥安全

- **密钥生成**: 在 HSM 内生成，使用真随机数
- **密钥存储**: 密钥永不离开 HSM 未加密状态
- **密钥传输**: 使用安全通道（TLS）
- **密钥销毁**: 安全擦除，符合 NIST 标准

### 5.3 访问安全

- **最小权限原则**: 只授予必要的权限
- **加密上下文**: 防止密钥滥用
- **审计追踪**: 所有操作可追溯
- **异常检测**: 实时监控异常访问

---

## 6. 性能优化

### 6.1 缓存策略

- **密钥元数据缓存**: Redis 缓存，TTL 5-10分钟
- **策略缓存**: 内存缓存，减少数据库查询
- **HSM 连接池**: 复用 HSM 连接

### 6.2 异步处理

- **审计日志**: 异步写入，不阻塞主流程
- **密钥轮换**: 后台任务异步执行
- **备份任务**: 定时异步备份

### 6.3 数据库优化

- **索引优化**: 关键字段建立索引
- **查询优化**: 避免全表扫描
- **连接池**: 数据库连接池管理
- **读写分离**: 读操作使用从库

---

## 7. 监控与运维

### 7.1 监控指标

**系统指标**:
- CPU、内存、磁盘使用率
- 网络流量
- 请求延迟（P50、P95、P99）
- 错误率

**业务指标**:
- API 调用量（QPS）
- 密钥操作次数
- 加密解密次数
- 策略评估次数

**安全指标**:
- 认证失败次数
- 授权拒绝次数
- 异常访问尝试
- 审计日志量

### 7.2 日志管理

- **应用日志**: 结构化日志（JSON 格式）
- **审计日志**: 不可篡改的审计日志
- **错误日志**: 错误追踪和告警
- **日志聚合**: ELK Stack 或 Loki

### 7.3 告警机制

- **系统告警**: CPU、内存、磁盘告警
- **业务告警**: 错误率、延迟告警
- **安全告警**: 异常访问、认证失败告警
- **告警渠道**: 邮件、短信、Slack、PagerDuty

---

## 8. 部署架构

### 8.1 容器化部署

```yaml
# docker-compose.yml 示例
version: '3.8'
services:
  kms-api:
    image: kms:latest
    ports:
      - "8080:8080"
    environment:
      - STORAGE_BACKEND=postgresql
      - DB_HOST=postgres
      - HSM_TYPE=pkcs11
    depends_on:
      - postgres
      - redis
  
  postgres:
    image: postgres:14
    environment:
      - POSTGRES_DB=kms
    volumes:
      - postgres_data:/var/lib/postgresql/data
  
  redis:
    image: redis:7
    volumes:
      - redis_data:/data
```

### 8.2 Kubernetes 部署

```yaml
# k8s deployment 示例
apiVersion: apps/v1
kind: Deployment
metadata:
  name: kms
spec:
  replicas: 3
  selector:
    matchLabels:
      app: kms
  template:
    metadata:
      labels:
        app: kms
    spec:
      containers:
      - name: kms
        image: kms:latest
        ports:
        - containerPort: 8080
        env:
        - name: STORAGE_BACKEND
          value: "postgresql"
```

---

## 9. 技术选型

### 9.1 开发语言

- **推荐**: Go
  - 性能优秀
  - 并发支持好
  - 部署简单
  - 生态丰富

- **备选**: Java
  - 企业级应用广泛
  - 生态成熟
  - 但资源消耗较大

### 9.2 框架和库

- **Web 框架**: Gin / Echo (Go) 或 Spring Boot (Java)
- **gRPC**: 高性能 RPC 框架
- **数据库驱动**: pgx (Go) 或 HikariCP (Java)
- **HSM 库**: PKCS#11 标准库
- **加密库**: crypto/rand, crypto/aes (Go)

### 9.3 基础设施

- **数据库**: PostgreSQL（推荐）或 MySQL
- **缓存**: Redis
- **消息队列**: RabbitMQ 或 Kafka（异步任务）
- **服务发现**: Consul 或 Kubernetes Service
- **监控**: Prometheus + Grafana
- **日志**: ELK Stack 或 Loki

---

## 10. 扩展性设计

### 10.1 水平扩展

- **无状态服务**: API 服务无状态，可水平扩展
- **存储扩展**: 数据库和 HSM 集群扩展
- **负载均衡**: 多节点负载均衡

### 10.2 插件化架构

参考 HashiCorp Vault 的插件系统：

- **存储后端插件**: 支持自定义存储后端
- **认证插件**: 支持自定义认证方式
- **审计插件**: 支持自定义审计输出

### 10.3 API 版本管理

- **版本控制**: URL 路径版本（/v1/, /v2/）
- **向后兼容**: 保持旧版本 API 可用
- **平滑升级**: 支持多版本并存

---

**文档维护**: 架构团队  
**最后更新**: 2024

