# KMS 部署指南

**版本**: v1.0  
**文档类型**: 部署文档

---

## 1. 部署概述

本文档提供 KMS 的部署指南，包括环境要求、部署方式、配置说明和运维建议。

### 1.1 部署方式

- **Docker 部署**: 使用 Docker 容器部署（推荐开发测试）
- **Kubernetes 部署**: 使用 K8s 部署（推荐生产环境）
- **传统部署**: 直接在服务器上部署（特殊场景）

### 1.2 部署架构

```
┌─────────────────────────────────────┐
│         Load Balancer / API Gateway │
└──────────────┬──────────────────────┘
               │
    ┌──────────┼──────────┐
    │          │          │
┌───▼───┐  ┌───▼───┐  ┌───▼───┐
│ KMS   │  │ KMS   │  │ KMS   │
│ Node 1│  │ Node 2│  │ Node 3│
└───┬───┘  └───┬───┘  └───┬───┘
    │          │          │
    └──────────┼──────────┘
               │
    ┌──────────┼──────────┐
    │          │          │
┌───▼───┐  ┌───▼───┐  ┌───▼───┐
│PostgreSQL│ │PostgreSQL│ │PostgreSQL│
│Primary  │ │Replica  │ │Replica  │
└─────────┘ └─────────┘ └─────────┘
    │
┌───▼───┐
│  HSM  │
│Cluster│
└───────┘
```

---

## 2. 环境要求

### 2.1 硬件要求

#### 最小配置（开发测试）
- **CPU**: 2 核
- **内存**: 4 GB
- **磁盘**: 50 GB SSD
- **网络**: 100 Mbps

#### 推荐配置（生产环境）
- **CPU**: 8+ 核
- **内存**: 16+ GB
- **磁盘**: 500+ GB SSD（高性能）
- **网络**: 1 Gbps+

### 2.2 软件要求

#### 操作系统
- **Linux**: Ubuntu 20.04+, CentOS 8+, RHEL 8+
- **容器**: Docker 20.10+, Kubernetes 1.20+

#### 依赖软件
- **PostgreSQL**: 12+ 或 MySQL 8+
- **Redis**: 6.0+（缓存）
- **HSM**: PKCS#11 兼容设备（生产环境）

---

## 3. Docker 部署

### 3.1 快速开始

#### 使用 Docker Compose

```yaml
# docker-compose.yml
version: '3.8'

services:
  postgres:
    image: postgres:14
    environment:
      POSTGRES_DB: kms
      POSTGRES_USER: kms
      POSTGRES_PASSWORD: ${DB_PASSWORD}
    volumes:
      - postgres_data:/var/lib/postgresql/data
    ports:
      - "5432:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U kms"]
      interval: 10s
      timeout: 5s
      retries: 5

  redis:
    image: redis:7-alpine
    volumes:
      - redis_data:/data
    ports:
      - "6379:6379"
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  kms:
    image: kms:latest
    environment:
      - STORAGE_BACKEND=postgresql
      - DB_HOST=postgres
      - DB_PORT=5432
      - DB_NAME=kms
      - DB_USER=kms
      - DB_PASSWORD=${DB_PASSWORD}
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - HSM_TYPE=software  # 开发环境使用软件 HSM
      - LOG_LEVEL=info
    ports:
      - "8080:8080"
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    volumes:
      - ./config:/etc/kms
      - ./logs:/var/log/kms

volumes:
  postgres_data:
  redis_data:
```

#### 启动服务

```bash
# 创建环境变量文件
cat > .env <<EOF
DB_PASSWORD=your-secure-password
EOF

# 启动服务
docker-compose up -d

# 查看日志
docker-compose logs -f kms

# 检查服务状态
docker-compose ps
```

### 3.2 配置说明

#### 环境变量配置

```bash
# 存储后端
STORAGE_BACKEND=postgresql  # postgresql, mysql, consul, file

# 数据库配置
DB_HOST=postgres
DB_PORT=5432
DB_NAME=kms
DB_USER=kms
DB_PASSWORD=your-password

# Redis 配置
REDIS_HOST=redis
REDIS_PORT=6379
REDIS_PASSWORD=  # 可选

# HSM 配置
HSM_TYPE=pkcs11  # pkcs11, software, cloudhsm
HSM_LIBRARY=/usr/lib/libpkcs11.so
HSM_SLOT=0
HSM_PIN=your-pin

# 服务配置
LISTEN_ADDRESS=0.0.0.0
LISTEN_PORT=8080
LOG_LEVEL=info  # debug, info, warn, error

# 安全配置
TLS_ENABLED=true
TLS_CERT_FILE=/etc/kms/tls/cert.pem
TLS_KEY_FILE=/etc/kms/tls/key.pem

# 认证配置
AUTH_TYPE=token  # token, approle, ldap, oauth
TOKEN_TTL=24h
```

---

## 4. Kubernetes 部署

### 4.1 部署清单

#### Namespace

```yaml
apiVersion: v1
kind: Namespace
metadata:
  name: kms
```

#### ConfigMap

```yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: kms-config
  namespace: kms
data:
  config.yaml: |
    storage:
      backend: postgresql
      postgresql:
        host: postgres
        port: 5432
        database: kms
        user: kms
    cache:
      redis:
        host: redis
        port: 6379
    hsm:
      type: pkcs11
      library: /usr/lib/libpkcs11.so
    server:
      listen: "0.0.0.0:8080"
      tls:
        enabled: true
```

#### Secret

```yaml
apiVersion: v1
kind: Secret
metadata:
  name: kms-secrets
  namespace: kms
type: Opaque
stringData:
  db-password: your-db-password
  hsm-pin: your-hsm-pin
  tls-cert: |
    -----BEGIN CERTIFICATE-----
    ...
    -----END CERTIFICATE-----
  tls-key: |
    -----BEGIN PRIVATE KEY-----
    ...
    -----END PRIVATE KEY-----
```

#### Deployment

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: kms
  namespace: kms
spec:
  replicas: 3
  selector:
    matchLabels:
      app: kms
  template:
    metadata:
      labels:
        app: kms
    spec:
      containers:
      - name: kms
        image: kms:latest
        ports:
        - containerPort: 8080
          name: http
        env:
        - name: STORAGE_BACKEND
          value: postgresql
        - name: DB_HOST
          value: postgres
        - name: DB_PASSWORD
          valueFrom:
            secretKeyRef:
              name: kms-secrets
              key: db-password
        volumeMounts:
        - name: config
          mountPath: /etc/kms
        - name: hsm
          mountPath: /usr/lib/libpkcs11.so
          readOnly: true
        resources:
          requests:
            cpu: 500m
            memory: 1Gi
          limits:
            cpu: 2000m
            memory: 4Gi
        livenessProbe:
          httpGet:
            path: /health
            port: 8080
          initialDelaySeconds: 30
          periodSeconds: 10
        readinessProbe:
          httpGet:
            path: /ready
            port: 8080
          initialDelaySeconds: 10
          periodSeconds: 5
      volumes:
      - name: config
        configMap:
          name: kms-config
      - name: hsm
        hostPath:
          path: /usr/lib/libpkcs11.so
```

#### Service

```yaml
apiVersion: v1
kind: Service
metadata:
  name: kms
  namespace: kms
spec:
  selector:
    app: kms
  ports:
  - port: 8080
    targetPort: 8080
    protocol: TCP
  type: ClusterIP
```

#### Ingress

```yaml
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: kms-ingress
  namespace: kms
  annotations:
    cert-manager.io/cluster-issuer: letsencrypt-prod
spec:
  tls:
  - hosts:
    - kms.example.com
    secretName: kms-tls
  rules:
  - host: kms.example.com
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: kms
            port:
              number: 8080
```

### 4.2 部署步骤

```bash
# 创建命名空间
kubectl create namespace kms

# 创建 ConfigMap
kubectl apply -f configmap.yaml

# 创建 Secret
kubectl apply -f secret.yaml

# 部署 KMS
kubectl apply -f deployment.yaml

# 创建 Service
kubectl apply -f service.yaml

# 创建 Ingress
kubectl apply -f ingress.yaml

# 检查部署状态
kubectl get pods -n kms
kubectl get svc -n kms
kubectl get ingress -n kms
```

---

## 5. 数据库部署

### 5.1 PostgreSQL 部署

#### Docker 部署

```yaml
# postgres.yml
version: '3.8'
services:
  postgres:
    image: postgres:14
    environment:
      POSTGRES_DB: kms
      POSTGRES_USER: kms
      POSTGRES_PASSWORD: ${DB_PASSWORD}
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./init.sql:/docker-entrypoint-initdb.d/init.sql
    ports:
      - "5432:5432"
```

#### 初始化脚本

```sql
-- init.sql
CREATE DATABASE kms;

\c kms;

-- 创建密钥表
CREATE TABLE keys (
    key_id VARCHAR(255) PRIMARY KEY,
    alias VARCHAR(255) UNIQUE,
    description TEXT,
    key_type VARCHAR(50),
    key_state VARCHAR(50),
    key_spec JSONB,
    policy_id VARCHAR(255),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    deletion_date TIMESTAMP,
    tags JSONB
);

-- 创建索引
CREATE INDEX idx_keys_alias ON keys(alias);
CREATE INDEX idx_keys_state ON keys(key_state);
CREATE INDEX idx_keys_created_at ON keys(created_at);

-- 创建审计日志表
CREATE TABLE audit_logs (
    id BIGSERIAL PRIMARY KEY,
    timestamp TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    event_type VARCHAR(50),
    user_id VARCHAR(255),
    key_id VARCHAR(255),
    operation VARCHAR(50),
    result VARCHAR(50),
    details JSONB,
    ip_address VARCHAR(50)
);

CREATE INDEX idx_audit_timestamp ON audit_logs(timestamp);
CREATE INDEX idx_audit_key_id ON audit_logs(key_id);
CREATE INDEX idx_audit_user_id ON audit_logs(user_id);
```

### 5.2 高可用配置

#### PostgreSQL 主从复制

```yaml
# 主库配置
services:
  postgres-master:
    image: postgres:14
    environment:
      POSTGRES_REPLICATION_USER: replicator
      POSTGRES_REPLICATION_PASSWORD: ${REPLICATION_PASSWORD}
    command: >
      postgres
      -c wal_level=replica
      -c max_wal_senders=3
      -c max_replication_slots=3

# 从库配置
  postgres-replica:
    image: postgres:14
    environment:
      PGUSER: replicator
      POSTGRES_MASTER_SERVICE: postgres-master
    command: >
      postgres
      -c hot_standby=on
```

---

## 6. HSM 配置

### 6.1 软件 HSM（开发测试）

#### SoftHSM 安装

```bash
# Ubuntu/Debian
sudo apt-get install softhsm2

# 初始化 SoftHSM
softhsm2-util --init-token --slot 0 --label "KMS" --pin 1234 --so-pin 5678

# 配置 PKCS#11
export PKCS11_LIBRARY=/usr/lib/softhsm/libsofthsm2.so
```

### 6.2 硬件 HSM（生产环境）

#### PKCS#11 配置

```bash
# 安装 HSM 驱动
# 根据 HSM 厂商提供的驱动安装

# 配置 PKCS#11 库路径
export PKCS11_LIBRARY=/usr/lib/libpkcs11.so

# 配置 HSM 连接
# 在 KMS 配置文件中设置
hsm:
  type: pkcs11
  library: /usr/lib/libpkcs11.so
  slot: 0
  pin: ${HSM_PIN}
```

---

## 7. 监控配置

### 7.1 Prometheus 配置

#### KMS Metrics 端点

```yaml
# KMS 暴露 metrics 端点
/metrics

# Prometheus 配置
scrape_configs:
  - job_name: 'kms'
    static_configs:
      - targets: ['kms:8080']
    metrics_path: '/metrics'
```

### 7.2 Grafana 仪表板

```json
{
  "dashboard": {
    "title": "KMS Dashboard",
    "panels": [
      {
        "title": "API Request Rate",
        "targets": [
          {
            "expr": "rate(kms_http_requests_total[5m])"
          }
        ]
      },
      {
        "title": "API Latency",
        "targets": [
          {
            "expr": "histogram_quantile(0.99, kms_http_request_duration_seconds_bucket)"
          }
        ]
      }
    ]
  }
}
```

---

## 8. 备份与恢复

### 8.1 数据库备份

#### 自动备份脚本

```bash
#!/bin/bash
# backup.sh

BACKUP_DIR=/backup/kms
DATE=$(date +%Y%m%d_%H%M%S)
DB_NAME=kms
DB_USER=kms

# 创建备份目录
mkdir -p $BACKUP_DIR

# 备份数据库
pg_dump -U $DB_USER -d $DB_NAME | gzip > $BACKUP_DIR/kms_$DATE.sql.gz

# 删除 30 天前的备份
find $BACKUP_DIR -name "kms_*.sql.gz" -mtime +30 -delete

# 上传到云存储（可选）
# aws s3 cp $BACKUP_DIR/kms_$DATE.sql.gz s3://kms-backups/
```

#### Cron 定时任务

```bash
# 每天凌晨 2 点备份
0 2 * * * /usr/local/bin/backup.sh
```

### 8.2 恢复流程

```bash
# 停止 KMS 服务
docker-compose stop kms

# 恢复数据库
gunzip < /backup/kms/kms_20240115_020000.sql.gz | psql -U kms -d kms

# 启动 KMS 服务
docker-compose start kms
```

---

## 9. 安全加固

### 9.1 网络安全

#### 防火墙规则

```bash
# 仅允许必要的端口
ufw allow 22/tcp   # SSH
ufw allow 8080/tcp  # KMS API
ufw enable
```

#### TLS 配置

```bash
# 生成自签名证书（开发环境）
openssl req -x509 -newkey rsa:4096 -keyout key.pem -out cert.pem -days 365 -nodes

# 使用 Let's Encrypt（生产环境）
certbot certonly --standalone -d kms.example.com
```

### 9.2 访问控制

#### 限制 API 访问

```yaml
# Nginx 配置
location /v1/ {
    # IP 白名单
    allow 192.168.1.0/24;
    deny all;
    
    # 限流
    limit_req zone=api_limit burst=10 nodelay;
    
    proxy_pass http://kms:8080;
}
```

---

## 10. 性能优化

### 10.1 数据库优化

```sql
-- 连接池配置
-- postgresql.conf
max_connections = 200
shared_buffers = 4GB
effective_cache_size = 12GB
maintenance_work_mem = 1GB
checkpoint_completion_target = 0.9
wal_buffers = 16MB
default_statistics_target = 100
random_page_cost = 1.1
effective_io_concurrency = 200
work_mem = 20MB
min_wal_size = 1GB
max_wal_size = 4GB
```

### 10.2 Redis 优化

```conf
# redis.conf
maxmemory 2gb
maxmemory-policy allkeys-lru
save ""  # 禁用持久化（仅缓存）
```

---

## 11. 故障排查

### 11.1 日志查看

```bash
# Docker 日志
docker-compose logs -f kms

# Kubernetes 日志
kubectl logs -f deployment/kms -n kms

# 应用日志
tail -f /var/log/kms/kms.log
```

### 11.2 健康检查

```bash
# 健康检查端点
curl http://localhost:8080/health

# 就绪检查端点
curl http://localhost:8080/ready

# 指标端点
curl http://localhost:8080/metrics
```

### 11.3 常见问题

#### 数据库连接失败
- 检查数据库服务是否运行
- 检查网络连接
- 检查认证信息

#### HSM 连接失败
- 检查 HSM 驱动是否安装
- 检查 PKCS#11 库路径
- 检查 HSM PIN 是否正确

#### 性能问题
- 检查数据库连接池
- 检查 Redis 缓存
- 检查 HSM 性能

---

## 12. 升级指南

### 12.1 升级流程

```bash
# 1. 备份数据
./backup.sh

# 2. 停止服务
docker-compose stop kms

# 3. 拉取新镜像
docker-compose pull kms

# 4. 启动服务
docker-compose up -d kms

# 5. 验证服务
curl http://localhost:8080/health

# 6. 回滚（如需要）
docker-compose down
docker-compose up -d kms:previous-version
```

### 12.2 数据库迁移

```bash
# 运行数据库迁移脚本
docker-compose exec kms ./migrate up
```

---

**文档维护**: 运维团队  
**最后更新**: 2024

