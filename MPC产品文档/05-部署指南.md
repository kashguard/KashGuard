# MPC 部署指南

**版本**: v1.0  
**文档类型**: 部署文档

---

## 1. 部署概述

本文档提供 MPC 基础设施的部署指南，包括环境要求、部署方式、配置说明和运维建议。MPC 服务支持单节点部署（开发测试）和多节点部署（生产环境）。

### 1.1 部署方式

- **单节点部署**: 使用 Docker 容器部署（推荐开发测试）
- **多节点部署**: 使用 Kubernetes 部署（推荐生产环境）
- **传统部署**: 直接在服务器上部署（特殊场景）

### 1.2 部署架构

```
┌─────────────────────────────────────┐
│         Load Balancer / API Gateway │
└──────────────┬──────────────────────┘
               │
    ┌──────────┼──────────┐
    │          │          │
┌───▼───┐  ┌───▼───┐  ┌───▼───┐
│Coord. │  │Coord. │  │Coord. │
│Node 1 │  │Node 2 │  │Node 3 │
└───┬───┘  └───┬───┘  └───┬───┘
    │          │          │
    └──────────┼──────────┘
               │
    ┌──────────┼──────────┐
    │          │          │
┌───▼───┐  ┌───▼───┐  ┌───▼───┐
│Part.  │  │Part.  │  │Part.  │
│Node 1 │  │Node 2 │  │Node 3 │
│       │  │       │  │       │
│Key    │  │Key    │  │Key    │
│Share  │  │Share  │  │Share  │
└───────┘  └───────┘  └───────┘
    │          │          │
    └──────────┼──────────┘
               │
    ┌──────────▼──────────┐
    │   Storage Layer     │
    │  ┌──────────────┐  │
    │  │PostgreSQL    │  │
    │  │Redis         │  │
    │  │Key Share FS  │  │
    │  └──────────────┘  │
    └─────────────────────┘
```

---

## 2. 环境要求

### 2.1 硬件要求

#### 最小配置（开发测试）
- **CPU**: 4 核
- **内存**: 8 GB
- **磁盘**: 100 GB SSD
- **网络**: 100 Mbps

#### 推荐配置（生产环境）
- **CPU**: 8+ 核
- **内存**: 16+ GB
- **磁盘**: 500+ GB SSD（高性能）
- **网络**: 1 Gbps+（节点间低延迟）

### 2.2 软件要求

#### 操作系统
- **Linux**: Ubuntu 20.04+, CentOS 8+, RHEL 8+
- **容器**: Docker 20.10+, Kubernetes 1.20+

#### 依赖软件
- **PostgreSQL**: 12+（元数据存储）
- **Redis**: 6.0+（会话缓存）
- **Go**: 1.19+（如果从源码编译）

---

## 3. 单节点部署（开发测试）

### 3.1 Docker Compose 部署

```yaml
# docker-compose.yml
version: '3.8'

services:
  postgres:
    image: postgres:14
    environment:
      POSTGRES_DB: mpc
      POSTGRES_USER: mpc
      POSTGRES_PASSWORD: ${DB_PASSWORD}
    volumes:
      - postgres_data:/var/lib/postgresql/data
    ports:
      - "5432:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U mpc"]
      interval: 10s
      timeout: 5s
      retries: 5

  redis:
    image: redis:7-alpine
    volumes:
      - redis_data:/data
    ports:
      - "6379:6379"
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  mpc-coordinator:
    image: mpc:latest
    environment:
      - NODE_TYPE=coordinator
      - NODE_ID=coordinator-1
      - DB_HOST=postgres
      - DB_PORT=5432
      - DB_NAME=mpc
      - DB_USER=mpc
      - DB_PASSWORD=${DB_PASSWORD}
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - KEY_SHARE_STORAGE_PATH=/var/lib/mpc/key-shares
      - LOG_LEVEL=info
    ports:
      - "8080:8080"
      - "9090:9090"  # gRPC
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    volumes:
      - ./config:/etc/mpc
      - ./key-shares:/var/lib/mpc/key-shares
      - ./logs:/var/log/mpc

  mpc-participant-1:
    image: mpc:latest
    environment:
      - NODE_TYPE=participant
      - NODE_ID=participant-1
      - COORDINATOR_ENDPOINT=http://mpc-coordinator:8080
      - KEY_SHARE_STORAGE_PATH=/var/lib/mpc/key-shares
      - LOG_LEVEL=info
    volumes:
      - ./key-shares-1:/var/lib/mpc/key-shares
      - ./logs:/var/log/mpc

  mpc-participant-2:
    image: mpc:latest
    environment:
      - NODE_TYPE=participant
      - NODE_ID=participant-2
      - COORDINATOR_ENDPOINT=http://mpc-coordinator:8080
      - KEY_SHARE_STORAGE_PATH=/var/lib/mpc/key-shares
      - LOG_LEVEL=info
    volumes:
      - ./key-shares-2:/var/lib/mpc/key-shares
      - ./logs:/var/log/mpc

  mpc-participant-3:
    image: mpc:latest
    environment:
      - NODE_TYPE=participant
      - NODE_ID=participant-3
      - COORDINATOR_ENDPOINT=http://mpc-coordinator:8080
      - KEY_SHARE_STORAGE_PATH=/var/lib/mpc/key-shares
      - LOG_LEVEL=info
    volumes:
      - ./key-shares-3:/var/lib/mpc/key-shares
      - ./logs:/var/log/mpc

volumes:
  postgres_data:
  redis_data:
```

#### 启动服务

```bash
# 创建环境变量文件
cat > .env <<EOF
DB_PASSWORD=your-secure-password
EOF

# 启动服务
docker-compose up -d

# 查看日志
docker-compose logs -f mpc-coordinator

# 检查服务状态
docker-compose ps
```

### 3.2 配置说明

#### 环境变量配置

```bash
# 节点配置
NODE_TYPE=coordinator  # coordinator 或 participant
NODE_ID=coordinator-1
COORDINATOR_ENDPOINT=http://coordinator:8080

# 数据库配置
DB_HOST=postgres
DB_PORT=5432
DB_NAME=mpc
DB_USER=mpc
DB_PASSWORD=your-password

# Redis 配置
REDIS_HOST=redis
REDIS_PORT=6379
REDIS_PASSWORD=  # 可选

# 存储配置
KEY_SHARE_STORAGE_PATH=/var/lib/mpc/key-shares
KEY_SHARE_ENCRYPTION_KEY=your-encryption-key

# 服务配置
LISTEN_ADDRESS=0.0.0.0
HTTP_PORT=8080
GRPC_PORT=9090
LOG_LEVEL=info  # debug, info, warn, error

# 协议配置
SUPPORTED_PROTOCOLS=gg18,gg20,frost
DEFAULT_PROTOCOL=gg20

# 安全配置
TLS_ENABLED=true
TLS_CERT_FILE=/etc/mpc/tls/cert.pem
TLS_KEY_FILE=/etc/mpc/tls/key.pem

# 认证配置
AUTH_TYPE=token  # token, certificate
TOKEN_TTL=24h
```

---

## 4. Kubernetes 部署（生产环境）

### 4.1 部署清单

#### Namespace

```yaml
apiVersion: v1
kind: Namespace
metadata:
  name: mpc
```

#### ConfigMap

```yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: mpc-config
  namespace: mpc
data:
  config.yaml: |
    node:
      type: coordinator
      id: coordinator-1
    storage:
      key_share_path: /var/lib/mpc/key-shares
      encryption_key: ${ENCRYPTION_KEY}
    database:
      host: postgres
      port: 5432
      name: mpc
      user: mpc
    redis:
      host: redis
      port: 6379
    protocols:
      supported: ["gg18", "gg20", "frost"]
      default: "gg20"
    server:
      http_port: 8080
      grpc_port: 9090
      tls:
        enabled: true
```

#### Secret

```yaml
apiVersion: v1
kind: Secret
metadata:
  name: mpc-secrets
  namespace: mpc
type: Opaque
stringData:
  db-password: your-db-password
  encryption-key: your-encryption-key
  tls-cert: |
    -----BEGIN CERTIFICATE-----
    ...
    -----END CERTIFICATE-----
  tls-key: |
    -----BEGIN PRIVATE KEY-----
    ...
    -----END PRIVATE KEY-----
```

#### Coordinator Deployment

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: mpc-coordinator
  namespace: mpc
spec:
  replicas: 3
  selector:
    matchLabels:
      app: mpc
      role: coordinator
  template:
    metadata:
      labels:
        app: mpc
        role: coordinator
    spec:
      containers:
      - name: mpc
        image: mpc:latest
        ports:
        - containerPort: 8080
          name: http
        - containerPort: 9090
          name: grpc
        env:
        - name: NODE_TYPE
          value: coordinator
        - name: NODE_ID
          valueFrom:
            fieldRef:
              fieldPath: metadata.name
        - name: DB_PASSWORD
          valueFrom:
            secretKeyRef:
              name: mpc-secrets
              key: db-password
        volumeMounts:
        - name: config
          mountPath: /etc/mpc
        - name: key-shares
          mountPath: /var/lib/mpc/key-shares
        resources:
          requests:
            cpu: 1000m
            memory: 2Gi
          limits:
            cpu: 4000m
            memory: 8Gi
        livenessProbe:
          httpGet:
            path: /health
            port: 8080
          initialDelaySeconds: 30
          periodSeconds: 10
        readinessProbe:
          httpGet:
            path: /ready
            port: 8080
          initialDelaySeconds: 10
          periodSeconds: 5
      volumes:
      - name: config
        configMap:
          name: mpc-config
      - name: key-shares
        persistentVolumeClaim:
          claimName: mpc-key-shares-pvc
```

#### Participant Deployment

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: mpc-participant
  namespace: mpc
spec:
  replicas: 5
  selector:
    matchLabels:
      app: mpc
      role: participant
  template:
    metadata:
      labels:
        app: mpc
        role: participant
    spec:
      containers:
      - name: mpc
        image: mpc:latest
        ports:
        - containerPort: 8080
          name: http
        - containerPort: 9090
          name: grpc
        env:
        - name: NODE_TYPE
          value: participant
        - name: NODE_ID
          valueFrom:
            fieldRef:
              fieldPath: metadata.name
        - name: COORDINATOR_ENDPOINT
          value: http://mpc-coordinator:8080
        volumeMounts:
        - name: key-shares
          mountPath: /var/lib/mpc/key-shares
        resources:
          requests:
            cpu: 500m
            memory: 1Gi
          limits:
            cpu: 2000m
            memory: 4Gi
      volumes:
      - name: key-shares
        persistentVolumeClaim:
          claimName: mpc-key-shares-pvc
```

#### Service

```yaml
apiVersion: v1
kind: Service
metadata:
  name: mpc-coordinator
  namespace: mpc
spec:
  selector:
    app: mpc
    role: coordinator
  ports:
  - port: 8080
    targetPort: 8080
    protocol: TCP
    name: http
  - port: 9090
    targetPort: 9090
    protocol: TCP
    name: grpc
  type: ClusterIP
```

#### Ingress

```yaml
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: mpc-ingress
  namespace: mpc
  annotations:
    cert-manager.io/cluster-issuer: letsencrypt-prod
spec:
  tls:
  - hosts:
    - mpc.example.com
    secretName: mpc-tls
  rules:
  - host: mpc.example.com
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: mpc-coordinator
            port:
              number: 8080
```

### 4.2 部署步骤

```bash
# 创建命名空间
kubectl create namespace mpc

# 创建 ConfigMap
kubectl apply -f configmap.yaml

# 创建 Secret
kubectl apply -f secret.yaml

# 部署 Coordinator
kubectl apply -f coordinator-deployment.yaml

# 部署 Participant
kubectl apply -f participant-deployment.yaml

# 创建 Service
kubectl apply -f service.yaml

# 创建 Ingress
kubectl apply -f ingress.yaml

# 检查部署状态
kubectl get pods -n mpc
kubectl get svc -n mpc
kubectl get ingress -n mpc
```

---

## 5. 数据库部署

### 5.1 PostgreSQL 部署

#### 初始化脚本

```sql
-- init.sql
CREATE DATABASE mpc;

\c mpc;

-- 密钥元数据表
CREATE TABLE keys (
    key_id VARCHAR(255) PRIMARY KEY,
    public_key TEXT,
    algorithm VARCHAR(50),
    curve VARCHAR(50),
    threshold INTEGER,
    total_nodes INTEGER,
    chain_type VARCHAR(50),
    address TEXT,
    status VARCHAR(50),
    description TEXT,
    tags JSONB,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 节点表
CREATE TABLE nodes (
    node_id VARCHAR(255) PRIMARY KEY,
    node_type VARCHAR(50),
    endpoint VARCHAR(255),
    public_key TEXT,
    status VARCHAR(50),
    capabilities JSONB,
    metadata JSONB,
    registered_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    last_heartbeat TIMESTAMP
);

-- 签名会话表
CREATE TABLE signing_sessions (
    session_id VARCHAR(255) PRIMARY KEY,
    key_id VARCHAR(255),
    protocol VARCHAR(50),
    status VARCHAR(50),
    threshold INTEGER,
    total_nodes INTEGER,
    participating_nodes JSONB,
    current_round INTEGER,
    total_rounds INTEGER,
    signature TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    completed_at TIMESTAMP,
    duration_ms INTEGER
);

-- 审计日志表
CREATE TABLE audit_logs (
    id BIGSERIAL PRIMARY KEY,
    timestamp TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    event_type VARCHAR(50),
    user_id VARCHAR(255),
    key_id VARCHAR(255),
    node_id VARCHAR(255),
    operation VARCHAR(50),
    result VARCHAR(50),
    details JSONB,
    ip_address VARCHAR(50)
);

-- 创建索引
CREATE INDEX idx_keys_chain_type ON keys(chain_type);
CREATE INDEX idx_keys_status ON keys(status);
CREATE INDEX idx_nodes_status ON nodes(status);
CREATE INDEX idx_sessions_key_id ON signing_sessions(key_id);
CREATE INDEX idx_sessions_status ON signing_sessions(status);
CREATE INDEX idx_audit_timestamp ON audit_logs(timestamp);
CREATE INDEX idx_audit_key_id ON audit_logs(key_id);
```

---

## 6. 密钥分片存储配置

### 6.1 存储路径

#### 本地文件系统
```bash
# 创建存储目录
mkdir -p /var/lib/mpc/key-shares

# 设置权限
chmod 700 /var/lib/mpc/key-shares
chown mpc:mpc /var/lib/mpc/key-shares
```

#### 加密文件系统
```bash
# 使用加密文件系统（可选）
# 例如：使用 LUKS 加密
cryptsetup luksFormat /dev/sdb1
cryptsetup open /dev/sdb1 mpc-encrypted
mkfs.ext4 /dev/mapper/mpc-encrypted
mount /dev/mapper/mpc-encrypted /var/lib/mpc/key-shares
```

### 6.2 加密配置

#### 加密密钥生成
```bash
# 生成加密密钥
openssl rand -hex 32 > /etc/mpc/encryption-key

# 设置权限
chmod 600 /etc/mpc/encryption-key
chown mpc:mpc /etc/mpc/encryption-key
```

---

## 7. 网络配置

### 7.1 节点间通信

#### 网络要求
- **低延迟**: 节点间网络延迟 < 50ms
- **高带宽**: 节点间带宽 > 100 Mbps
- **稳定性**: 网络稳定性 > 99.9%

#### 防火墙规则
```bash
# 允许节点间通信
# Coordinator 端口
ufw allow 8080/tcp  # HTTP
ufw allow 9090/tcp  # gRPC

# Participant 端口
ufw allow 8080/tcp  # HTTP
ufw allow 9090/tcp  # gRPC
```

### 7.2 TLS 配置

#### 生成证书
```bash
# 生成自签名证书（开发环境）
openssl req -x509 -newkey rsa:4096 -keyout key.pem -out cert.pem -days 365 -nodes

# 使用 Let's Encrypt（生产环境）
certbot certonly --standalone -d mpc.example.com
```

---

## 8. 监控配置

### 8.1 Prometheus 配置

#### Metrics 端点
```yaml
# MPC 暴露 metrics 端点
/metrics

# Prometheus 配置
scrape_configs:
  - job_name: 'mpc-coordinator'
    static_configs:
      - targets: ['mpc-coordinator:8080']
    metrics_path: '/metrics'
  
  - job_name: 'mpc-participant'
    static_configs:
      - targets: ['mpc-participant:8080']
    metrics_path: '/metrics'
```

### 8.2 Grafana 仪表板

#### 关键指标
- 签名延迟（P50、P95、P99）
- 签名吞吐量（签名/秒）
- 节点在线率
- 签名成功率
- 会话数量
- 节点 CPU、内存使用率

---

## 9. 备份与恢复

### 9.1 数据备份

#### 数据库备份
```bash
#!/bin/bash
# backup.sh

BACKUP_DIR=/backup/mpc
DATE=$(date +%Y%m%d_%H%M%S)
DB_NAME=mpc
DB_USER=mpc

# 创建备份目录
mkdir -p $BACKUP_DIR

# 备份数据库
pg_dump -U $DB_USER -d $DB_NAME | gzip > $BACKUP_DIR/mpc_$DATE.sql.gz

# 备份密钥分片元数据（不备份实际分片）
tar -czf $BACKUP_DIR/key-shares-meta_$DATE.tar.gz /var/lib/mpc/key-shares/*.meta

# 删除 30 天前的备份
find $BACKUP_DIR -name "*.gz" -mtime +30 -delete
```

#### 定时任务
```bash
# 每天凌晨 2 点备份
0 2 * * * /usr/local/bin/backup.sh
```

### 9.2 恢复流程

```bash
# 停止 MPC 服务
docker-compose stop mpc-coordinator mpc-participant-*

# 恢复数据库
gunzip < /backup/mpc/mpc_20240115_020000.sql.gz | psql -U mpc -d mpc

# 恢复密钥分片元数据
tar -xzf /backup/mpc/key-shares-meta_20240115_020000.tar.gz -C /

# 启动 MPC 服务
docker-compose start mpc-coordinator mpc-participant-*
```

---

## 10. 性能调优

### 10.1 数据库优化

```sql
-- postgresql.conf
max_connections = 200
shared_buffers = 4GB
effective_cache_size = 12GB
maintenance_work_mem = 1GB
checkpoint_completion_target = 0.9
wal_buffers = 16MB
default_statistics_target = 100
random_page_cost = 1.1
effective_io_concurrency = 200
work_mem = 20MB
min_wal_size = 1GB
max_wal_size = 4GB
```

### 10.2 Redis 优化

```conf
# redis.conf
maxmemory 2gb
maxmemory-policy allkeys-lru
save ""  # 禁用持久化（仅缓存）
```

### 10.3 应用优化

#### 并发配置
```yaml
# config.yaml
server:
  max_concurrent_sessions: 100
  max_concurrent_signings: 50
  session_timeout: 300
```

---

## 11. 故障排查

### 11.1 日志查看

```bash
# Docker 日志
docker-compose logs -f mpc-coordinator

# Kubernetes 日志
kubectl logs -f deployment/mpc-coordinator -n mpc

# 应用日志
tail -f /var/log/mpc/mpc.log
```

### 11.2 健康检查

```bash
# 健康检查端点
curl http://localhost:8080/health

# 就绪检查端点
curl http://localhost:8080/ready

# 节点状态
curl http://localhost:8080/v1/nodes

# 指标端点
curl http://localhost:8080/metrics
```

### 11.3 常见问题

#### 节点无法连接
- 检查网络连接
- 检查防火墙规则
- 检查节点状态

#### 签名失败
- 检查节点在线状态
- 检查阈值配置
- 查看签名会话日志

#### 性能问题
- 检查数据库连接
- 检查 Redis 缓存
- 检查节点负载

---

## 12. 升级指南

### 12.1 升级流程

```bash
# 1. 备份数据
./backup.sh

# 2. 停止服务
docker-compose stop mpc-coordinator mpc-participant-*

# 3. 拉取新镜像
docker-compose pull mpc

# 4. 启动服务
docker-compose up -d mpc-coordinator mpc-participant-*

# 5. 验证服务
curl http://localhost:8080/health

# 6. 回滚（如需要）
docker-compose down
docker-compose up -d mpc:previous-version
```

### 12.2 数据库迁移

```bash
# 运行数据库迁移脚本
docker-compose exec mpc-coordinator ./migrate up
```

---

**文档维护**: 运维团队  
**最后更新**: 2024

