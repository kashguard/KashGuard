# MPC 架构设计文档

**版本**: v1.0  
**文档类型**: 技术架构

---

## 1. 架构概述

MPC 基础设施采用分布式、去中心化的架构设计，基于阈值签名技术（TSS），确保高可用、高性能、安全可靠。架构支持多种部署模式，包括协调者模式和 P2P 模式，满足不同场景的需求。

### 1.1 架构原则

- **分布式架构**: 无单点故障，节点间对等通信
- **模块化设计**: 清晰的组件划分，易于扩展
- **安全优先**: 密钥分片安全，协议安全，通信安全
- **高可用**: 多节点部署，自动故障转移
- **高性能**: 低延迟签名，高吞吐量，水平扩展

### 1.2 架构图

```
┌─────────────────────────────────────────────────────────┐
│                   客户端层 (Clients)                     │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌─────────┐ │
│  │ Web UI   │  │  CLI     │  │  SDK     │  │  API    │ │
│  └────┬─────┘  └────┬─────┘  └────┬─────┘  └────┬─────┘ │
└───────┼─────────────┼─────────────┼─────────────┼───────┘
        │             │             │             │
        └─────────────┴─────────────┴─────────────┘
                            │
        ┌───────────────────▼───────────────────┐
        │          API Gateway / Load Balancer  │
        │      (认证、限流、路由、监控)            │
        └───────────────────┬───────────────────┘
                            │
        ┌───────────────────▼───────────────────┐
        │         MPC Coordinator Service       │
        │  ┌──────────┐  ┌──────────┐          │
        │  │  HTTP    │  │  gRPC    │          │
        │  │  Server  │  │  Server  │          │
        │  └────┬─────┘  └────┬─────┘          │
        └───────┼─────────────┼─────────────────┘
                │             │
        ┌───────▼─────────────▼───────┐
        │      MPC Core Logic          │
        │  ┌────────────────────────┐ │
        │  │  Protocol Engine        │ │
        │  │  (GG18/GG20/FROST)     │ │
        │  ├────────────────────────┤ │
        │  │  Key Share Manager     │ │
        │  ├────────────────────────┤ │
        │  │  Signing Service       │ │
        │  ├────────────────────────┤ │
        │  │  Node Manager          │ │
        │  └────────────────────────┘ │
        └───────┬───────────────────────┘
                │
        ┌───────▼───────────────────────┐
        │      Storage Layer            │
        │  ┌──────────────────────────┐ │
        │  │  Key Share Storage        │ │
        │  │  (Encrypted)              │ │
        │  ├──────────────────────────┤ │
        │  │  Session Storage          │ │
        │  │  (Redis/PostgreSQL)       │ │
        │  ├──────────────────────────┤ │
        │  │  Metadata Store          │ │
        │  │  (PostgreSQL)            │ │
        │  └──────────────────────────┘ │
        └───────┬───────────────────────┘
                │
        ┌───────▼───────────────────────┐
        │      Participant Nodes        │
        │  ┌──────────┐  ┌──────────┐  │
        │  │ Node 1   │  │ Node 2   │  │
        │  │          │  │          │  │
        │  │ Key Share│  │ Key Share│  │
        │  │ Storage  │  │ Storage  │  │
        │  └────┬─────┘  └────┬─────┘  │
        │       │             │         │
        │  ┌────▼─────────────▼─────┐  │
        │  │  P2P Communication     │  │
        │  │  (gRPC/WebSocket)      │  │
        │  └────────────────────────┘  │
        └──────────────────────────────┘
```

---

## 2. 核心组件

### 2.1 MPC Coordinator Service

**职责**:
- 协调多方签名流程
- 管理签名会话
- 节点注册和发现
- 负载均衡和路由

**核心模块**:

#### 2.1.1 Protocol Engine
```go
type ProtocolEngine interface {
    // 密钥生成
    GenerateKeyShare(req *KeyGenRequest) (*KeyShare, error)
    
    // 阈值签名
    ThresholdSign(req *SignRequest) (*Signature, error)
    
    // 签名验证
    VerifySignature(sig *Signature, msg []byte, pubKey *PublicKey) (bool, error)
    
    // 密钥轮换
    RotateKey(keyID string) error
}
```

#### 2.1.2 Key Share Manager
```go
type KeyShareManager interface {
    // 分片存储
    StoreKeyShare(keyID string, share *KeyShare) error
    
    // 分片获取
    GetKeyShare(keyID string, nodeID string) (*KeyShare, error)
    
    // 分片分发
    DistributeKeyShare(keyID string, nodes []string) error
    
    // 分片恢复
    RecoverKeyShare(keyID string, shares []*KeyShare) (*KeyShare, error)
}
```

#### 2.1.3 Signing Service
```go
type SigningService interface {
    // 创建签名会话
    CreateSigningSession(req *SigningSessionRequest) (*SigningSession, error)
    
    // 加入签名会话
    JoinSigningSession(sessionID string, nodeID string) error
    
    // 提交签名分片
    SubmitSignatureShare(sessionID string, share *SignatureShare) error
    
    // 聚合签名
    AggregateSignatures(sessionID string) (*Signature, error)
}
```

#### 2.1.4 Node Manager
```go
type NodeManager interface {
    // 节点注册
    RegisterNode(node *Node) error
    
    // 节点发现
    DiscoverNodes(filter *NodeFilter) ([]*Node, error)
    
    // 节点状态
    GetNodeStatus(nodeID string) (*NodeStatus, error)
    
    // 节点健康检查
    HealthCheck(nodeID string) (bool, error)
}
```

### 2.2 Participant Node

**职责**:
- 存储密钥分片
- 参与签名协议
- 与其他节点通信
- 执行签名计算

**核心模块**:

#### 2.2.1 Key Share Storage
```go
type KeyShareStorage interface {
    // 存储分片
    StoreShare(keyID string, share *KeyShare) error
    
    // 获取分片
    GetShare(keyID string) (*KeyShare, error)
    
    // 删除分片
    DeleteShare(keyID string) error
    
    // 列出所有分片
    ListShares() ([]string, error)
}
```

#### 2.2.2 Protocol Participant
```go
type ProtocolParticipant interface {
    // 参与密钥生成
    ParticipateKeyGen(sessionID string) (*KeyShare, error)
    
    // 参与签名
    ParticipateSign(sessionID string, msg []byte) (*SignatureShare, error)
    
    // 验证其他节点的消息
    VerifyMessage(fromNodeID string, msg *ProtocolMessage) (bool, error)
}
```

#### 2.2.3 P2P Communication
```go
type P2PCommunicator interface {
    // 发送消息
    SendMessage(toNodeID string, msg *ProtocolMessage) error
    
    // 广播消息
    Broadcast(msg *ProtocolMessage) error
    
    // 接收消息
    ReceiveMessage() (*ProtocolMessage, error)
    
    // 建立连接
    Connect(nodeID string) error
}
```

### 2.3 Storage Layer

#### 2.3.1 Key Share Storage

**加密存储**:
- 密钥分片使用 AES-256-GCM 加密
- 加密密钥由节点本地管理
- 支持 HSM 集成（可选）

**存储后端**:
- **PostgreSQL**: 元数据和分片索引
- **加密文件系统**: 分片实际存储
- **HSM**: 高安全场景（可选）

#### 2.3.2 Session Storage

**Redis 存储**:
- 签名会话状态
- 临时数据缓存
- 消息队列

**PostgreSQL 存储**:
- 会话元数据
- 审计日志
- 历史记录

#### 2.3.3 Metadata Store

**存储内容**:
- 密钥元数据（KeyID、公钥、阈值配置）
- 节点信息
- 签名历史
- 审计日志

---

## 3. 分布式架构

### 3.1 节点角色

#### Coordinator（协调者）
- **职责**: 协调签名流程，管理会话
- **数量**: 1 个主协调者，多个备用协调者
- **特点**: 不存储密钥分片，仅协调流程

#### Participant（参与者）
- **职责**: 存储密钥分片，参与签名
- **数量**: N 个（根据阈值配置）
- **特点**: 存储密钥分片，执行签名计算

### 3.2 通信协议

#### gRPC
- **用途**: 节点间高效通信
- **特点**: 高性能、类型安全
- **场景**: 签名协议消息、节点管理

#### WebSocket
- **用途**: 实时通信和事件推送
- **特点**: 双向通信、低延迟
- **场景**: 签名会话状态更新、事件通知

#### HTTP/REST
- **用途**: 客户端 API
- **特点**: 标准协议、易于集成
- **场景**: SDK 调用、管理接口

### 3.3 一致性保证

#### 签名会话一致性
- 使用分布式锁（Redis）
- 会话状态同步
- 消息顺序保证

#### 密钥分片一致性
- 分片版本管理
- 分片同步机制
- 一致性验证

### 3.4 容错机制

#### 节点故障处理
- 故障检测（心跳机制）
- 自动故障转移
- 签名会话恢复

#### 网络分区处理
- 分区检测
- 多数派决策
- 分区恢复

---

## 4. 密钥分片管理

### 4.1 分片生成

#### 分布式密钥生成（DKG）

**流程**:
```
1. Coordinator 创建密钥生成会话
2. 所有 Participant 节点参与
3. 每个节点生成随机分片
4. 节点间交换和验证分片
5. 生成最终密钥分片
6. 计算公钥
```

**安全保证**:
- 真随机数生成
- 分片验证
- 恶意节点检测

### 4.2 分片存储

#### 加密存储
- 分片使用 AES-256-GCM 加密
- 加密密钥由节点本地管理
- 支持 HSM 保护（可选）

#### 存储位置
- 每个节点存储自己的分片
- 分片不离开节点未加密状态
- 支持备份和恢复

### 4.3 分片分发

#### 安全分发
- 使用 TLS 加密传输
- 节点认证和授权
- 分片完整性验证

#### 分发流程
```
1. Coordinator 确定参与节点
2. 验证节点身份
3. 加密分片
4. 安全传输到目标节点
5. 节点验证和存储分片
```

### 4.4 分片恢复

#### 恢复场景
- 节点故障导致分片丢失
- 需要重新生成密钥
- 密钥轮换

#### 恢复流程
```
1. 收集阈值数量的分片
2. 验证分片有效性
3. 重构完整密钥（仅用于恢复）
4. 重新生成分片
5. 分发新分片
```

---

## 5. 签名流程

### 5.1 阈值签名流程

#### 完整流程

```
1. 客户端发起签名请求
   ↓
2. Coordinator 创建签名会话
   ↓
3. Coordinator 通知参与节点
   ↓
4. 节点加入签名会话
   ↓
5. 节点执行签名协议（GG18/GG20/FROST）
   ├── Round 1: 生成随机数
   ├── Round 2: 交换消息
   ├── Round 3: 计算签名分片
   └── Round 4: 聚合签名
   ↓
6. Coordinator 聚合签名分片
   ↓
7. 生成最终签名
   ↓
8. 验证签名
   ↓
9. 返回签名给客户端
```

### 5.2 多方协作协议

#### GG18/GG20 协议

**特点**:
- 4 轮通信
- 支持 ECDSA
- 恶意节点防护

**流程**:
1. **Round 1**: 生成随机数，交换承诺
2. **Round 2**: 交换随机数，验证承诺
3. **Round 3**: 计算签名分片
4. **Round 4**: 聚合签名分片，生成最终签名

#### FROST 协议

**特点**:
- 2 轮通信（更高效）
- 支持 Schnorr 签名
- IETF 标准

**流程**:
1. **Round 1**: 生成随机数，交换承诺
2. **Round 2**: 聚合签名

### 5.3 签名聚合

#### 聚合算法
- 使用 Shamir 秘密共享
- 拉格朗日插值
- 签名分片聚合

#### 验证
- 验证签名分片有效性
- 验证最终签名
- 验证公钥匹配

---

## 6. 高可用架构

### 6.1 多节点部署

#### Coordinator 高可用
```
┌─────────────┐
│ Coordinator │ (主)
│   Node 1    │
└──────┬──────┘
       │
┌──────▼──────┐
│ Coordinator │ (备)
│   Node 2    │
└─────────────┘
```

- 主备模式
- 自动故障转移
- 状态同步

#### Participant 高可用
```
Participant Nodes (N 个)
├── Node 1 (分片 1)
├── Node 2 (分片 2)
├── Node 3 (分片 3)
└── ...
```

- 多节点部署
- 阈值容错（M-of-N）
- 自动故障检测

### 6.2 故障转移

#### Coordinator 故障转移
- 心跳检测
- 自动选举新 Coordinator
- 会话状态恢复

#### Participant 故障处理
- 节点故障检测
- 使用备用节点
- 签名会话继续（只要达到阈值）

### 6.3 负载均衡

#### 签名请求负载均衡
- 多个 Coordinator 节点
- 请求分发
- 会话负载均衡

#### 节点负载均衡
- Participant 节点负载均衡
- 签名任务分配
- 性能监控

---

## 7. 性能优化

### 7.1 签名延迟优化

#### 并发处理
- 并发签名会话
- 异步消息处理
- 批量签名

#### 网络优化
- 节点间低延迟网络
- 消息压缩
- 连接复用

#### 协议优化
- 使用 FROST（2 轮）替代 GG18（4 轮）
- 批量签名优化
- 预计算优化

### 7.2 吞吐量优化

#### 水平扩展
- 增加 Participant 节点
- 增加 Coordinator 节点
- 负载均衡

#### 批量处理
- 批量签名请求
- 批量消息处理
- 批量验证

#### 缓存策略
- 会话状态缓存
- 公钥缓存
- 节点信息缓存

### 7.3 资源优化

#### CPU 优化
- 加密计算优化
- 并行计算
- 硬件加速（可选）

#### 内存优化
- 分片内存管理
- 会话状态管理
- 缓存管理

#### 存储优化
- 分片存储优化
- 数据库索引优化
- 日志归档

---

## 8. 技术选型

### 8.1 开发语言

#### 推荐: Go
- **优势**: 
  - 并发支持好（goroutine）
  - 性能优秀
  - 标准库丰富
  - 部署简单
- **适用**: 核心服务、协议实现

#### 备选: Rust
- **优势**:
  - 内存安全
  - 性能优秀
  - 适合密码学计算
- **适用**: 性能关键模块

### 8.2 协议库

#### tss-lib (Go)
- Binance 开源
- 支持 GG18/GG20
- 生产环境验证

#### ZenGo-X/multi-party-ecdsa (Rust)
- Rust 实现
- 性能优秀
- 支持多种曲线

#### FROST (Rust)
- IETF 标准
- 支持 Schnorr
- 2 轮通信

### 8.3 存储

#### PostgreSQL
- 元数据存储
- 会话管理
- 审计日志

#### Redis
- 会话状态缓存
- 分布式锁
- 消息队列

#### 加密文件系统
- 密钥分片存储
- 本地加密

### 8.4 通信

#### gRPC
- 节点间通信
- 高性能
- 类型安全

#### WebSocket
- 实时通信
- 事件推送
- 双向通信

---

## 9. 扩展性设计

### 9.1 水平扩展

#### 节点扩展
- 动态添加 Participant 节点
- 动态添加 Coordinator 节点
- 自动负载均衡

#### 存储扩展
- 数据库分片
- 分布式存储
- 缓存集群

### 9.2 功能扩展

#### 新协议支持
- 插件化协议引擎
- 新协议集成
- 协议版本管理

#### 新链支持
- 插件化链适配器
- 新链集成
- 链特定功能

### 9.3 API 扩展

#### API 版本管理
- URL 路径版本（/v1/, /v2/）
- 向后兼容
- 平滑升级

#### SDK 扩展
- 多语言 SDK
- SDK 插件
- 开发者工具

---

## 10. 监控与运维

### 10.1 监控指标

#### 性能指标
- 签名延迟（P50、P95、P99）
- 吞吐量（签名/秒）
- 节点 CPU、内存使用率

#### 业务指标
- 签名请求数
- 签名成功率
- 节点在线率
- 会话数量

#### 安全指标
- 认证失败次数
- 签名验证失败次数
- 异常访问尝试
- 节点故障次数

### 10.2 日志管理

#### 应用日志
- 结构化日志（JSON）
- 日志级别（DEBUG、INFO、WARN、ERROR）
- 日志聚合（ELK Stack）

#### 审计日志
- 所有签名操作
- 密钥生成和轮换
- 节点管理操作
- 不可篡改

### 10.3 告警机制

#### 系统告警
- 节点故障告警
- 性能下降告警
- 存储空间告警

#### 业务告警
- 签名失败率告警
- 签名延迟告警
- 会话超时告警

#### 安全告警
- 异常访问告警
- 认证失败告警
- 签名验证失败告警

---

**文档维护**: 架构团队  
**最后更新**: 2024

